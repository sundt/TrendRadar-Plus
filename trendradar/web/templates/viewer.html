<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendRadar - æ–°é—»åˆ†ç±»æŸ¥çœ‹å™¨</title>
    <!-- ç™¾åº¦ç»Ÿè®¡ -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?66fb2effb4714e3c3f0b0c0053b8dc83";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
            --cross-platform-color: #f97316;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 24px 0 56px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
        }

        .main-container { max-width: 1400px; margin: 0 auto; padding: 0 15px; min-height: calc(100vh - 80px); display: flex; flex-direction: column; gap: 10px; }

        .header-card {
            background: white;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: 0.2px;
            color: #111827;
            margin-bottom: 0;
        }

        .header-top {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-subtitle {
            display: inline-flex;
            align-items: center;
            height: 24px;
            line-height: 1;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .stats-row {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .online-chips {
            display: inline-flex;
            gap: 6px;
            margin-left: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .online-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.7rem;
            line-height: 1;
            background: rgba(255, 255, 255, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.24);
            color: rgba(255, 255, 255, 0.95);
        }

        .online-chip b {
            font-weight: 800;
            color: #ffffff;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
        }

        .stat-label { opacity: 0.9; }
        .stat-value { font-weight: 600; }

        /* Tab å¯¼èˆª */
        .category-tabs {
            background: white;
            border-radius: 10px;
            padding: 6px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 6px;
            overflow-x: auto;
        }

        .category-tab {
            flex: 1;
            min-width: 80px;
            padding: 6px 10px;
            background: #f3f4f6;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .category-tab:hover { background: #e5e7eb; }

        .category-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .category-tab-icon { font-size: 1rem; }
        .category-tab-name { font-size: 0.8rem; font-weight: 600; }
        .category-tab-count { font-size: 0.65rem; opacity: 0.8; }

        .tab-content-area {
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-height: 520px;
            flex: 1;
        }

        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .platform-grid {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .platform-grid::-webkit-scrollbar { height: 6px; }
        .platform-grid::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .platform-grid::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .platform-grid::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

        .platform-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 10px;
            flex: 0 0 auto;
            width: 280px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .platform-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.15);
        }

        .platform-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e5e7eb;
        }

        .news-list { list-style: none; padding: 0; margin: 0; }

        .news-item {
            padding: 4px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.8rem;
            box-sizing: border-box;
            height: calc(1.4em * 2 + 8px);
        }

        .news-item:last-child { border-bottom: none; }

        .news-title {
            font-size: 0.8rem;
            color: #1f2937;
            line-height: 1.4;
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .news-item.preview .news-meta,
        .news-item:hover .news-meta,
        .news-item:focus-within .news-meta {
            display: none;
        }

        .news-item.preview .news-title,
        .news-item:hover .news-title,
        .news-item:focus-within .news-title {
            white-space: normal;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .news-item.filtered { display: none !important; }
        .news-item.read { display: none !important; }
        .news-item.paged-hidden { display: none !important; }

        /* æ˜¾ç¤ºå·²è¯»æ¨¡å¼ä¸‹çš„å·²è¯»æ–°é—» */
        body.show-read-mode .news-item.read {
            display: block !important;
            opacity: 0.5;
            background: #fef3c7;
        }
        body.show-read-mode .news-item.read:hover {
            opacity: 0.8;
        }

        /* å·²è¯»æŒ‰é’®æ ·å¼ */
        .show-read-btn {
            padding: 4px 10px;
            background: #fef3c7;
            color: #92400e;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .show-read-btn.active {
            background: #fbbf24;
            color: white;
        }
        .clear-read-btn {
            padding: 4px 10px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 6px;
        }
        .clear-read-btn:hover {
            background: #fca5a5;
        }

        .platform-refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 0;
            padding: 6px 10px;
            background: #eef2ff;
            color: #4338ca;
            border: 1px solid #c7d2fe;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
        }

        .platform-refresh-btn:hover {
            background: #e0e7ff;
            border-color: #a5b4fc;
        }

        .platform-refresh-btn:active {
            transform: translateY(1px);
        }

        .news-checkbox {
            width: 14px;
            height: 14px;
            margin-right: 6px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .news-item-content {
            display: flex;
            align-items: flex-start;
        }

        .platform-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e5e7eb;
        }

        .news-title a {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s;
            pointer-events: none;
            cursor: text;
        }

        .news-title {
            cursor: pointer;
        }

        /* è·¨å¹³å°é«˜äº® */
        .news-title.cross-platform {
            color: var(--cross-platform-color);
            font-weight: 600;
            border-left: 3px solid var(--cross-platform-color);
            padding-left: 8px;
        }

        .news-title.cross-platform a {
            color: var(--cross-platform-color);
        }

        .news-title.cross-platform a:hover {
            color: #ea580c;
        }

        .cross-platform-badge {
            display: inline-flex;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 8px;
            cursor: help;
        }

        .news-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            line-height: 1.2;
            color: #6b7280;
            white-space: nowrap;
        }

        .rank-text {
            display: inline-flex;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: #9ca3af;
            letter-spacing: 0.2px;
        }

        /* è¿‡æ»¤é¢æ¿ */
        .filter-panel {
            display: none;
            margin-top: 8px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .filter-panel.show { display: block; }
        .filter-input-row { display: flex; gap: 6px; margin-bottom: 6px; }
        .filter-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .filter-add-btn {
            padding: 4px 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .filter-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 12px;
            font-size: 0.7rem;
        }
        .filter-tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
        }
        .filter-tag-remove:hover { opacity: 1; }
        .filter-toggle-btn {
            padding: 4px 10px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .filter-count {
            font-size: 0.7rem;
            color: #dc2626;
            margin-left: 4px;
        }

        /* å¹³å°ç­›é€‰æŒ‰é’®å’Œé¢æ¿ */
        .platform-filter-btn {
            padding: 4px 10px;
            background: #e0e7ff;
            color: #4338ca;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .platform-filter-panel {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }
        .platform-filter-panel.show { display: block; }
        .platform-filter-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }
        .platform-filter-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .platform-filter-item:hover {
            border-color: #4338ca;
        }
        .platform-filter-item.hidden {
            background: #f3f4f6;
            color: #9ca3af;
            text-decoration: line-through;
        }
        .platform-filter-item input {
            margin: 0;
            cursor: pointer;
        }
        .platform-filter-actions {
            display: flex;
            gap: 6px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        .platform-filter-actions button {
            padding: 4px 10px;
            font-size: 0.7rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        .platform-filter-actions button:hover {
            background: #f3f4f6;
        }

        /* éšè—çš„å¹³å°å¡ç‰‡ */
        .platform-card.platform-hidden {
            display: none !important;
        }

        /* è·å–æ•°æ®æŒ‰é’® */
        .fetch-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .fetch-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .fetch-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .fetch-btn .spinner { display: none; width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .fetch-btn.loading .spinner { display: inline-block; }
        .fetch-btn.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* è¿›åº¦æ¡ */
        .progress-container {
            display: none;
            margin-top: 10px;
            background: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            height: 6px;
        }
        .progress-container.show { display: block; }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 8px;
        }
        .progress-bar.indeterminate {
            width: 30%;
            animation: indeterminate 1.5s ease-in-out infinite;
        }
        @keyframes indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
        .fetch-status { font-size: 0.75rem; color: #6b7280; margin-top: 5px; }
        .fetch-status.success { color: #10b981; }
        .fetch-status.error { color: #ef4444; }

        @media (max-width: 768px) {
            .platform-card { width: 240px; }
            .stats-row { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-card">
            <div class="header-top">
                <a href="https://github.com/sundt/TrendRadar-Plus" target="_blank" class="header-title" style="text-decoration: none; color: inherit;"><svg height="24" width="24" viewBox="0 0 16 16" style="vertical-align: middle;"><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a>
                <span class="header-subtitle">æ™ºèƒ½åˆ†ç±» Â· ç²¾å‡†è¿‡æ»¤ Â· é«˜æ•ˆé˜…è¯»</span>
            </div>

            <div class="stats-row">
                <button class="fetch-btn" id="fetchBtn" onclick="fetchData()">
                    <span class="spinner"></span>
                    <span class="btn-text">ğŸ”„ åˆ·æ–°</span>
                </button>
                <button class="filter-toggle-btn" onclick="toggleFilterPanel()">
                    ğŸš« è¿‡æ»¤è®¾ç½® <span class="filter-count" id="filterCount"></span>
                </button>
                <button class="platform-filter-btn" onclick="togglePlatformFilterPanel()">
                    ğŸ“± å¹³å°ç­›é€‰ <span id="hiddenPlatformCount"></span>
                </button>
                <button class="show-read-btn" id="showReadBtn" onclick="toggleShowRead()">
                    ğŸ‘ å·²è¯»: <span id="readCount">0</span>
                </button>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);" id="filteredStatCard">
                    <span class="stat-label">å·²è¿‡æ»¤</span>
                    <span class="stat-value" id="filteredCount">0</span>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                    <span class="stat-label">æ›´æ–°</span>
                    <span class="stat-value" id="updatedAt">{{ data.updated_at }}</span>
                    <span class="online-chips" id="onlineChips" title="å®æ—¶åœ¨çº¿ï¼šæŒ‰æœ€è¿‘æ´»è·ƒæ—¶é—´ç»Ÿè®¡">
                        <span class="online-chip">åœ¨çº¿ <b id="online5m">-</b></span>
                    </span>
                </div>
                <button class="filter-toggle-btn" type="button" onclick="window.open('https://p2fjebt29i.feishu.cn/share/base/form/shrcnL6g8L6M6yFJU9gTnE4pBqe', '_blank')">
                    ğŸ’¡ å»ºè®®
                </button>
            </div>

            <!-- è¿‡æ»¤é¢æ¿ -->
            <div class="filter-panel" id="filterPanel">
                <div class="filter-input-row">
                    <input type="text" class="filter-input" id="filterInput" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå›è½¦æ·»åŠ ..." onkeypress="handleFilterKeypress(event)">
                    <button class="filter-add-btn" onclick="addFilterKeyword()">+ æ·»åŠ </button>
                </div>
                <div class="filter-tags" id="filterTags"></div>
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                    <button class="clear-read-btn" onclick="clearAllRead()">ğŸ—‘ æ¸…é™¤æ‰€æœ‰å·²è¯»è®°å½•</button>
                </div>
            </div>

            <!-- å¹³å°ç­›é€‰é¢æ¿ -->
            <div class="platform-filter-panel" id="platformFilterPanel">
                <div style="font-size: 0.8rem; color: #4338ca; margin-bottom: 8px; font-weight: 600;">ğŸ“± é€‰æ‹©è¦æ˜¾ç¤ºçš„å¹³å°</div>
                <div class="platform-filter-grid" id="platformFilterGrid"></div>
                <div class="platform-filter-actions">
                    <button onclick="selectAllPlatforms()">å…¨é€‰</button>
                    <button onclick="deselectAllPlatforms()">å…¨ä¸é€‰</button>
                    <button onclick="resetPlatformFilter()">é‡ç½®</button>
                </div>
            </div>

            <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="ğŸ” æœç´¢æ–°é—»..." onkeyup="searchNews()" style="flex: 1; font-size: 0.8rem; padding: 4px 8px;">
            </div>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="fetch-status" id="fetchStatus"></div>
        </div>

        <!-- Tabs -->
        <div class="category-tabs">
            {% for cat_id, category in data.categories.items() %}
            <div class="category-tab {% if loop.first %}active{% endif %}" 
                 data-category="{{ cat_id }}"
                 onclick="switchTab('{{ cat_id }}')">
                <div class="category-tab-icon">{{ category.icon }}</div>
                <div class="category-tab-name">{{ category.name }}</div>
            </div>
            {% endfor %}
        </div>

        <!-- Content -->
        <div class="tab-content-area">
            {% for cat_id, category in data.categories.items() %}
            <div class="tab-pane {% if loop.first %}active{% endif %}" id="tab-{{ cat_id }}">
                <div class="platform-grid">
                    {% for platform_id, platform in category.platforms.items() %}
                    <div class="platform-card" data-platform="{{ platform_id }}">
                        <div class="platform-header">
                            <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">
                                ğŸ“± {{ platform.name }}
                            </div>
                            <button class="platform-refresh-btn" type="button" onclick="refreshPlatform(this)" title="ä»…åˆ·æ–°æœ¬å¹³å°ï¼Œæ¢æ–°ï¼ˆ10æ¡ï¼‰">
                                <span>æ¢æ–°</span>
                            </button>
                        </div>
                        <ul class="news-list">
                            {% for news in platform.news %}
                            <li class="news-item" data-news-id="{{ news.stable_id }}" data-news-title="{{ news.title }}">
                                <div class="news-item-content">
                                    <input type="checkbox" class="news-checkbox" onchange="markAsRead(this)" title="æ ‡è®°å·²è¯»">
                                    <div class="news-title {% if news.is_cross_platform %}cross-platform{% endif %}" onclick="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)" tabindex="0" role="button" data-url="{{ news.url or '' }}">
                                        {{ news.title }}
                                        {% if news.is_cross_platform %}
                                        <span class="cross-platform-badge" title="åŒæ—¶å‡ºç°åœ¨: {{ news.cross_platforms|join(', ') }}">
                                            ğŸ”¥ {{ news.cross_platform_count }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="news-meta">
                                    <span class="rank-text">#{{ news.rank }}</span>
                                    <span>{{ news.timestamp }}</span>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        // === å·²è¯»çŠ¶æ€ç®¡ç†ï¼ˆåŸºäºå†…å®¹å“ˆå¸Œ + è‡ªåŠ¨è¿‡æœŸï¼‰ ===
        const READ_STORAGE_KEY = 'trendradar_read_news_v2';  // æ–°ç‰ˆæœ¬ key
        const OLD_STORAGE_KEY = 'trendradar_read_news';      // æ—§ç‰ˆæœ¬ key
        const EXPIRE_HOURS = 24;  // å·²è¯»è®°å½•è¿‡æœŸæ—¶é—´ï¼ˆå°æ—¶ï¼‰
        
        function getReadNews() {
            const stored = localStorage.getItem(READ_STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }
        
        function saveReadNews(reads) {
            localStorage.setItem(READ_STORAGE_KEY, JSON.stringify(reads));
        }
        
        // è¿ç§»æ—§æ ¼å¼æ•°æ®ï¼ˆæ¸…ç©ºï¼‰
        function migrateOldFormat() {
            if (localStorage.getItem(OLD_STORAGE_KEY)) {
                localStorage.removeItem(OLD_STORAGE_KEY);
                console.log('å·²æ¸…é™¤æ—§ç‰ˆæœ¬å·²è¯»è®°å½•');
            }
        }
        
        // æ¸…ç†è¿‡æœŸçš„å·²è¯»è®°å½•
        function cleanupExpiredReads() {
            const now = Date.now();
            const reads = getReadNews();
            let changed = false;
            let removedCount = 0;
            
            for (const [id, info] of Object.entries(reads)) {
                const ageHours = (now - info.readAt) / (1000 * 60 * 60);
                if (ageHours < EXPIRE_HOURS) {
                    // do nothing
                } else {
                    // å–æ¶ˆå‹¾é€‰ï¼Œä»å·²è¯»åˆ—è¡¨ç§»é™¤
                    const item = document.querySelector(`[data-news-id="${id}"]`);
                    if (item) {
                        item.classList.remove('read');
                        const checkbox = item.querySelector('.news-checkbox');
                        if (checkbox) checkbox.checked = false;
                    }
                    delete reads[id];
                    changed = true;
                    removedCount++;
                }
            }
            
            if (changed) {
                saveReadNews(reads);
            }
            return removedCount;
        }
        
        function markAsRead(checkbox) {
            const item = checkbox.closest('.news-item');
            const newsId = item.dataset.newsId;
            const newsTitle = item.dataset.newsTitle || '';
            let reads = getReadNews();
            
            if (checkbox.checked) {
                item.classList.add('read');
                if (!reads[newsId]) {
                    reads[newsId] = {
                        title: newsTitle.substring(0, 50),
                        readAt: Date.now()
                    };
                    saveReadNews(reads);
                }
            } else {
                // å–æ¶ˆå‹¾é€‰ï¼Œä»å·²è¯»åˆ—è¡¨ç§»é™¤
                item.classList.remove('read');
                delete reads[newsId];
                saveReadNews(reads);
            }
            // æ›´æ–°è®¡æ•°
            updatePlatformCount(checkbox.closest('.platform-card'));
            updateReadCount();
        }
        
        function updateReadCount() {
            const reads = getReadNews();
            const countEl = document.getElementById('readCount');
            if (countEl) countEl.textContent = Object.keys(reads).length;
        }
        
        function updatePlatformCount(card) {
            const visibleItems = card.querySelectorAll('.news-item:not(.read):not(.filtered):not(.paged-hidden)');
            const visibleEl = card.querySelector('.platform-visible-count');
            if (visibleEl) visibleEl.textContent = visibleItems.length;
        }
        
        function updateAllCounts() {
            document.querySelectorAll('.platform-card').forEach(card => {
                updatePlatformCount(card);
            });
            // æ›´æ–°æ€»æ•°
            const totalVisible = document.querySelectorAll('.news-item:not(.read):not(.filtered):not(.paged-hidden)').length;
            const totalEl = document.getElementById('totalNews');
            if (totalEl) totalEl.textContent = totalVisible;
        }
        
        function openLink(el) {
            const url = el.dataset.url;
            if (url) {
                window.open(url, '_blank');
            }
        }

        function isHoverDevice() {
            return (window.matchMedia && window.matchMedia('(hover: hover)').matches);
        }

        function closeAllPreviews(exceptItem) {
            document.querySelectorAll('.news-item.preview').forEach((it) => {
                if (exceptItem && it === exceptItem) return;
                it.classList.remove('preview');
            });
        }

        function handleTitleClickV2(el, evt) {
            evt.stopPropagation();
            const item = el.closest('.news-item');
            if (!item) return;

            if (isHoverDevice()) {
                openLink(el);
                return;
            }

            const isSame = item.classList.contains('preview');
            if (isSame) {
                openLink(el);
                item.classList.remove('preview');
                return;
            }

            closeAllPreviews(item);
            item.classList.add('preview');
        }

        function handleTitleKeydownV2(el, evt) {
            if (evt.key === 'Enter' || evt.key === ' ') {
                evt.preventDefault();
                handleTitleClickV2(el, evt);
            } else if (evt.key === 'Escape') {
                closeAllPreviews(null);
            }
        }

        document.addEventListener('click', (e) => {
            if (e.target.closest('.news-item')) return;
            closeAllPreviews(null);
        });
        document.addEventListener('touchstart', (e) => {
            if (e.target.closest('.news-item')) return;
            closeAllPreviews(null);
        }, { passive: true });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAllPreviews(null);
        });
        
        function restoreReadState() {
            const reads = getReadNews();
            Object.keys(reads).forEach(id => {
                const item = document.querySelector(`[data-news-id="${id}"]`);
                if (item) {
                    item.classList.add('read');
                    const checkbox = item.querySelector('.news-checkbox');
                    if (checkbox) checkbox.checked = true;
                }
            });
            // æ¢å¤åæ›´æ–°æ‰€æœ‰è®¡æ•°
            updateAllCounts();
            updateReadCount();
        }
        
        function toggleShowRead() {
            document.body.classList.toggle('show-read-mode');
            const btn = document.getElementById('showReadBtn');
            btn.classList.toggle('active');
            updateAllCounts();
        }
        
        function clearAllRead() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²è¯»è®°å½•å—ï¼Ÿæ‰€æœ‰æ–°é—»å°†æ¢å¤æ˜¾ç¤ºã€‚')) return;
            
            // æ¸…é™¤æ‰€æœ‰å·²è¯»çŠ¶æ€
            document.querySelectorAll('.news-item.read').forEach(item => {
                item.classList.remove('read');
                const checkbox = item.querySelector('.news-checkbox');
                if (checkbox) checkbox.checked = false;
            });
            
            // æ¸…ç©º localStorage
            saveReadNews({});
            
            // æ›´æ–°è®¡æ•°
            updateAllCounts();
            updateReadCount();
            
            // å…³é—­æ˜¾ç¤ºå·²è¯»æ¨¡å¼
            document.body.classList.remove('show-read-mode');
            document.getElementById('showReadBtn').classList.remove('active');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // 1. è¿ç§»æ—§æ ¼å¼æ•°æ®
            migrateOldFormat();
            // 2. æ¸…ç†è¿‡æœŸè®°å½•
            cleanupExpiredReads();
            // 3. æ¢å¤å·²è¯»çŠ¶æ€
            restoreReadState();
            initPaging();
        });

        const CATEGORY_PAGE_SIZE = 10;

        function applyPagingToCard(card, offset) {
            const items = Array.from(card.querySelectorAll('.news-item'));
            const total = items.length;
            if (total <= CATEGORY_PAGE_SIZE) {
                items.forEach((it) => it.classList.remove('paged-hidden'));
                card.dataset.pageOffset = '0';
                return;
            }

            const safeOffset = Math.max(0, Math.min(offset, total - 1));
            const end = Math.min(safeOffset + CATEGORY_PAGE_SIZE, total);

            items.forEach((it, idx) => {
                if (idx >= safeOffset && idx < end) it.classList.remove('paged-hidden');
                else it.classList.add('paged-hidden');
            });

            card.dataset.pageOffset = String(safeOffset);
        }

        function initPaging() {
            document.querySelectorAll('.platform-card').forEach((card) => {
                applyPagingToCard(card, 0);
            });
            updateAllCounts();
        }

        function refreshPlatform(btn) {
            const card = btn.closest('.platform-card');
            if (!card) return;
            const items = card.querySelectorAll('.news-item');
            const total = items.length;
            if (total <= CATEGORY_PAGE_SIZE) return;
            const current = parseInt(card.dataset.pageOffset || '0', 10);
            const next = (current + CATEGORY_PAGE_SIZE >= total) ? 0 : (current + CATEGORY_PAGE_SIZE);
            applyPagingToCard(card, next);
            updateAllCounts();
        }

        // === è¿‡æ»¤åŠŸèƒ½ ===
        const FILTER_STORAGE_KEY = 'trendradar_filter_keywords';
        
        function getFilterKeywords() {
            const stored = localStorage.getItem(FILTER_STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveFilterKeywords(keywords) {
            localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(keywords));
        }
        
        function toggleFilterPanel() {
            document.getElementById('filterPanel').classList.toggle('show');
        }
        
        function handleFilterKeypress(event) {
            if (event.key === 'Enter') {
                addFilterKeyword();
            }
        }
        
        function addFilterKeyword() {
            const input = document.getElementById('filterInput');
            const keyword = input.value.trim().toLowerCase();
            if (!keyword) return;
            
            const keywords = getFilterKeywords();
            if (!keywords.includes(keyword)) {
                keywords.push(keyword);
                saveFilterKeywords(keywords);
                renderFilterTags();
                applyFilter();
            }
            input.value = '';
        }
        
        function removeFilterKeyword(keyword) {
            let keywords = getFilterKeywords();
            keywords = keywords.filter(k => k !== keyword);
            saveFilterKeywords(keywords);
            renderFilterTags();
            applyFilter();
        }
        
        function renderFilterTags() {
            const container = document.getElementById('filterTags');
            const keywords = getFilterKeywords();
            
            container.innerHTML = keywords.map(k => 
                `<span class="filter-tag">${k}<span class="filter-tag-remove" onclick="removeFilterKeyword('${k}')">Ã—</span></span>`
            ).join('');
            
            // æ›´æ–°è¿‡æ»¤æŒ‰é’®ä¸Šçš„æ•°é‡
            const countEl = document.getElementById('filterCount');
            countEl.textContent = keywords.length > 0 ? `(${keywords.length})` : '';
        }
        
        function applyFilter() {
            const keywords = getFilterKeywords();
            let filteredCount = 0;
            
            document.querySelectorAll('.news-item').forEach(item => {
                const title = item.textContent.toLowerCase();
                const shouldFilter = keywords.some(k => title.includes(k));
                
                if (shouldFilter) {
                    item.classList.add('filtered');
                    filteredCount++;
                } else {
                    item.classList.remove('filtered');
                }
            });
            
            // æ›´æ–°å·²è¿‡æ»¤æ•°é‡
            document.getElementById('filteredCount').textContent = filteredCount;
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è¿‡æ»¤
        document.addEventListener('DOMContentLoaded', function() {
            renderFilterTags();
            applyFilter();
        });

        // === å¹³å°ç­›é€‰åŠŸèƒ½ ===
        const PLATFORM_FILTER_KEY = 'trendradar_hidden_platforms';
        
        function getHiddenPlatforms() {
            const stored = localStorage.getItem(PLATFORM_FILTER_KEY);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveHiddenPlatforms(platforms) {
            localStorage.setItem(PLATFORM_FILTER_KEY, JSON.stringify(platforms));
        }
        
        function togglePlatformFilterPanel() {
            const panel = document.getElementById('platformFilterPanel');
            panel.classList.toggle('show');
            if (panel.classList.contains('show')) {
                renderPlatformFilterGrid();
            }
        }
        
        function renderPlatformFilterGrid() {
            const container = document.getElementById('platformFilterGrid');
            const hiddenPlatforms = getHiddenPlatforms();
            const platforms = [];
            
            // æ”¶é›†æ‰€æœ‰å¹³å°
            document.querySelectorAll('.platform-card').forEach(card => {
                const platformId = card.dataset.platform;
                const platformName = card.querySelector('.platform-name').textContent.trim().replace(/ğŸ“±\s*/, '').split(' ')[0];
                if (platformId && !platforms.find(p => p.id === platformId)) {
                    platforms.push({ id: platformId, name: platformName });
                }
            });
            
            container.innerHTML = platforms.map(p => {
                const isHidden = hiddenPlatforms.includes(p.id);
                return `
                    <label class="platform-filter-item ${isHidden ? 'hidden' : ''}">
                        <input type="checkbox" ${!isHidden ? 'checked' : ''} onchange="togglePlatformVisibility('${p.id}')">
                        ${p.name}
                    </label>
                `;
            }).join('');
            
            updateHiddenPlatformCount();
        }
        
        function togglePlatformVisibility(platformId) {
            let hidden = getHiddenPlatforms();
            if (hidden.includes(platformId)) {
                hidden = hidden.filter(p => p !== platformId);
            } else {
                hidden.push(platformId);
            }
            saveHiddenPlatforms(hidden);
            applyPlatformFilter();
            renderPlatformFilterGrid();
        }
        
        function selectAllPlatforms() {
            saveHiddenPlatforms([]);
            applyPlatformFilter();
            renderPlatformFilterGrid();
        }
        
        function deselectAllPlatforms() {
            const allPlatforms = [];
            document.querySelectorAll('.platform-card').forEach(card => {
                const platformId = card.dataset.platform;
                if (platformId && !allPlatforms.includes(platformId)) {
                    allPlatforms.push(platformId);
                }
            });
            saveHiddenPlatforms(allPlatforms);
            applyPlatformFilter();
            renderPlatformFilterGrid();
        }
        
        function resetPlatformFilter() {
            localStorage.removeItem(PLATFORM_FILTER_KEY);
            applyPlatformFilter();
            renderPlatformFilterGrid();
        }
        
        function applyPlatformFilter() {
            const hidden = getHiddenPlatforms();
            document.querySelectorAll('.platform-card').forEach(card => {
                const platformId = card.dataset.platform;
                if (hidden.includes(platformId)) {
                    card.classList.add('platform-hidden');
                } else {
                    card.classList.remove('platform-hidden');
                }
            });
            updateHiddenPlatformCount();
        }
        
        function updateHiddenPlatformCount() {
            const hidden = getHiddenPlatforms();
            const countEl = document.getElementById('hiddenPlatformCount');
            if (countEl) {
                countEl.textContent = hidden.length > 0 ? `(éšè—${hidden.length})` : '';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å¹³å°ç­›é€‰
        document.addEventListener('DOMContentLoaded', function() {
            applyPlatformFilter();
            restoreActiveTab();
        });

        // === åœ¨çº¿äººæ•°ï¼ˆå¿ƒè·³ + ç»Ÿè®¡ï¼‰ ===
        const ONLINE_SESSION_KEY = 'trendradar_online_session_id';

        function getOnlineSessionId() {
            let id = localStorage.getItem(ONLINE_SESSION_KEY);
            if (id) return id;
            if (window.crypto && crypto.randomUUID) {
                id = crypto.randomUUID();
            } else {
                id = 'sess_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 10);
            }
            localStorage.setItem(ONLINE_SESSION_KEY, id);
            return id;
        }

        async function onlinePing() {
            try {
                await fetch('/api/online/ping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: getOnlineSessionId() })
                });
            } catch (e) {
                // ignore
            }
        }

        async function refreshOnlineStats() {
            try {
                const res = await fetch('/api/online');
                const data = await res.json();
                const el5 = document.getElementById('online5m');
                if (el5) el5.textContent = data.online_5m ?? '-';
            } catch (e) {
                // ignore
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            onlinePing();
            refreshOnlineStats();
            setInterval(onlinePing, 15000);
            setInterval(refreshOnlineStats, 10000);
        });

        // === Tab åˆ‡æ¢ ===
        const TAB_STORAGE_KEY = 'trendradar_active_tab';
        
        function switchTab(categoryId) {
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.category-tab[data-category="${categoryId}"]`).classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(`tab-${categoryId}`).classList.add('active');
            // ä¿å­˜å½“å‰TabçŠ¶æ€
            localStorage.setItem(TAB_STORAGE_KEY, categoryId);
        }
        
        function restoreActiveTab() {
            const savedTab = localStorage.getItem(TAB_STORAGE_KEY);
            if (savedTab) {
                const tabEl = document.querySelector(`.category-tab[data-category="${savedTab}"]`);
                if (tabEl) {
                    switchTab(savedTab);
                }
            }
        }

        // === æœç´¢ ===
        function searchNews() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const keywords = getFilterKeywords();
            
            document.querySelectorAll('.news-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                const matchSearch = !q || text.includes(q);
                const matchFilter = !keywords.some(k => text.includes(k));
                
                if (matchSearch && matchFilter) {
                    item.classList.remove('filtered');
                    item.style.display = '';
                } else if (!matchFilter) {
                    item.classList.add('filtered');
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // === æ•°æ®è·å– ===
        async function fetchData() {
            const btn = document.getElementById('fetchBtn');
            const progress = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            const status = document.getElementById('fetchStatus');

            btn.classList.add('loading');
            btn.disabled = true;
            progress.classList.add('show');
            bar.classList.add('indeterminate');
            status.className = 'fetch-status';
            status.textContent = 'æ­£åœ¨è·å–æ•°æ®...';

            try {
                const response = await fetch('/api/fetch', { method: 'POST' });
                const result = await response.json();

                bar.classList.remove('indeterminate');
                
                if (result.success) {
                    bar.style.width = '100%';
                    status.className = 'fetch-status success';
                    status.textContent = `âœ… ${result.platforms} ä¸ªå¹³å°ï¼Œ${result.news_count} æ¡æ–°é—»`;
                    setTimeout(() => refreshViewerData({ preserveScroll: true }), 300);
                } else {
                    bar.style.width = '0%';
                    status.className = 'fetch-status error';
                    status.textContent = `âŒ ${result.error}`;
                }
            } catch (error) {
                bar.classList.remove('indeterminate');
                bar.style.width = '0%';
                status.className = 'fetch-status error';
                status.textContent = `âŒ ${error.message}`;
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                setTimeout(() => {
                    progress.classList.remove('show');
                    bar.style.width = '0%';
                }, 5000);
            }
        }

        let _ajaxRefreshInFlight = false;
        let _ajaxLastRefreshAt = 0;

        function escapeHtml(str) {
            return String(str || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function snapshotViewerState() {
            const activeTab = localStorage.getItem(TAB_STORAGE_KEY) || (document.querySelector('.category-tab.active')?.dataset?.category) || null;
            const pagingOffsets = {};
            document.querySelectorAll('.platform-card').forEach((card) => {
                const pid = card.dataset.platform;
                if (!pid) return;
                pagingOffsets[pid] = parseInt(card.dataset.pageOffset || '0', 10) || 0;
            });
            return {
                activeTab,
                pagingOffsets,
                showReadMode: document.body.classList.contains('show-read-mode'),
                scrollY: window.scrollY || 0,
                searchText: (document.getElementById('searchInput')?.value || ''),
            };
        }

        function renderViewerFromData(data, state) {
            const tabsEl = document.querySelector('.category-tabs');
            const contentEl = document.querySelector('.tab-content-area');
            if (!tabsEl || !contentEl) return;

            const categories = data?.categories || {};

            const tabsHtml = Object.entries(categories).map(([catId, cat]) => {
                const icon = escapeHtml(cat?.icon || '');
                const name = escapeHtml(cat?.name || catId);
                return `
            <div class="category-tab" data-category="${escapeHtml(catId)}" onclick="switchTab('${escapeHtml(catId)}')">
                <div class="category-tab-icon">${icon}</div>
                <div class="category-tab-name">${name}</div>
            </div>`;
            }).join('');

            const contentHtml = Object.entries(categories).map(([catId, cat]) => {
                const platforms = cat?.platforms || {};
                const platformCards = Object.entries(platforms).map(([platformId, platform]) => {
                    const platformName = escapeHtml(platform?.name || platformId);
                    const news = Array.isArray(platform?.news) ? platform.news : [];
                    const newsItemsHtml = news.map((n) => {
                        const stableId = escapeHtml(n?.stable_id || '');
                        const title = escapeHtml(n?.title || '');
                        const url = escapeHtml(n?.url || '');
                        const ts = escapeHtml(n?.timestamp || '');
                        const rank = escapeHtml(n?.rank ?? '');
                        const isCross = !!n?.is_cross_platform;
                        const crossPlatforms = Array.isArray(n?.cross_platforms) ? n.cross_platforms : [];
                        const crossTitle = escapeHtml(crossPlatforms.join(', '));
                        const crossCount = escapeHtml(n?.cross_platform_count ?? '');
                        const crossBadge = isCross ? `<span class="cross-platform-badge" title="åŒæ—¶å‡ºç°åœ¨: ${crossTitle}">ğŸ”¥ ${crossCount}</span>` : '';
                        const crossClass = isCross ? 'cross-platform' : '';
                        return `
                            <li class="news-item" data-news-id="${stableId}" data-news-title="${title}">
                                <div class="news-item-content">
                                    <input type="checkbox" class="news-checkbox" onchange="markAsRead(this)" title="æ ‡è®°å·²è¯»">
                                    <div class="news-title ${crossClass}" onclick="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)" tabindex="0" role="button" data-url="${url}">
                                        ${title}
                                        ${crossBadge}
                                    </div>
                                </div>
                                <div class="news-meta">
                                    <span class="rank-text">#${rank}</span>
                                    <span>${ts}</span>
                                </div>
                            </li>`;
                    }).join('');

                    return `
                    <div class="platform-card" data-platform="${escapeHtml(platformId)}">
                        <div class="platform-header">
                            <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">ğŸ“± ${platformName}</div>
                            <button class="platform-refresh-btn" type="button" onclick="refreshPlatform(this)" title="ä»…åˆ·æ–°æœ¬å¹³å°ï¼Œæ¢æ–°ï¼ˆ10æ¡)"><span>æ¢æ–°</span></button>
                        </div>
                        <ul class="news-list">${newsItemsHtml}
                        </ul>
                    </div>`;
                }).join('');

                return `
            <div class="tab-pane" id="tab-${escapeHtml(catId)}">
                <div class="platform-grid">${platformCards}
                </div>
            </div>`;
            }).join('');

            tabsEl.innerHTML = tabsHtml;
            contentEl.innerHTML = contentHtml;

            const updatedAtEl = document.getElementById('updatedAt');
            if (updatedAtEl && data?.updated_at) updatedAtEl.textContent = data.updated_at;

            if (state?.activeTab) {
                switchTab(state.activeTab);
            } else {
                const firstTab = document.querySelector('.category-tab');
                if (firstTab?.dataset?.category) {
                    switchTab(firstTab.dataset.category);
                }
            }

            applyPlatformFilter();

            if (state?.showReadMode) {
                document.body.classList.add('show-read-mode');
                const btn = document.getElementById('showReadBtn');
                if (btn) btn.classList.add('active');
            } else {
                document.body.classList.remove('show-read-mode');
                const btn = document.getElementById('showReadBtn');
                if (btn) btn.classList.remove('active');
            }

            renderFilterTags();
            applyFilter();

            const searchEl = document.getElementById('searchInput');
            if (searchEl && typeof state?.searchText === 'string') {
                searchEl.value = state.searchText;
            }
            searchNews();

            restoreReadState();

            document.querySelectorAll('.platform-card').forEach((card) => {
                const pid = card.dataset.platform;
                const off = (pid && state?.pagingOffsets && Number.isFinite(state.pagingOffsets[pid])) ? state.pagingOffsets[pid] : 0;
                applyPagingToCard(card, off);
            });

            updateAllCounts();
            updateReadCount();
        }

        async function refreshViewerData(opts = {}) {
            if (_ajaxRefreshInFlight) return;
            _ajaxRefreshInFlight = true;
            try {
                const state = snapshotViewerState();
                const response = await fetch('/api/news');
                const data = await response.json();
                renderViewerFromData(data, state);
                if (opts.preserveScroll !== false) {
                    window.scrollTo({ top: state.scrollY, behavior: 'instant' });
                }
                _ajaxLastRefreshAt = Date.now();
            } catch (e) {
                // ignore
            } finally {
                _ajaxRefreshInFlight = false;
            }
        }

        function setupAjaxAutoRefresh() {
            const intervalMs = 300000;
            setInterval(() => {
                if (document.visibilityState !== 'visible') return;
                const now = Date.now();
                if (now - _ajaxLastRefreshAt < intervalMs - 5000) return;
                refreshViewerData({ preserveScroll: true });
            }, 5000);

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    refreshViewerData({ preserveScroll: true });
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            setupAjaxAutoRefresh();
        });
    </script>
</body>
</html>
