(()=>{var i=window.TrendRadar=window.TrendRadar||{},rt=[],ot=!1;function v(e){ot?e():rt.push(e)}document.addEventListener("DOMContentLoaded",function(){ot=!0,rt.forEach(e=>{try{e()}catch(t){console.error("Ready handler error:",t)}})});function S(e){return String(e||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function ne(e){let t=e==null?"":String(e).trim();if(!t)return t;let r=t.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::\d{2})?$/);return r?`${r[2]}-${r[3]} ${r[4]}:${r[5]}`:(t.match(/^(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/),t)}i.ready=v;i.escapeHtml=S;i.formatUpdatedAt=ne;var q={container:null,nextId:1,items:new Map};function nr(){if(q.container)return q.container;let e=document.createElement("div");e.id="tr-toast-container",e.style.position="fixed",e.style.right="16px",e.style.bottom="16px",e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px",e.style.zIndex="99999";try{document.body.appendChild(e)}catch{}return q.container=e,e}function ar(e){let t=String(e||"info");return t==="loading"?{bg:"#111827",fg:"#fff",border:"#111827"}:t==="success"?{bg:"#16a34a",fg:"#fff",border:"#16a34a"}:t==="error"?{bg:"#dc2626",fg:"#fff",border:"#dc2626"}:{bg:"#111827",fg:"#fff",border:"#111827"}}function tt(e,t,r){let o=ar(r);e.className="tr-toast",e.style.display="flex",e.style.alignItems="center",e.style.gap="10px",e.style.padding="10px 12px",e.style.borderRadius="10px",e.style.background=o.bg,e.style.color=o.fg,e.style.border=`1px solid ${o.border}`,e.style.boxShadow="0 10px 20px rgba(0,0,0,0.18)",e.style.fontSize="0.9rem",e.style.maxWidth="360px",e.style.wordBreak="break-word";let n=String(r||"info")==="loading"?'<span aria-hidden="true" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,0.3);"></span>':"";e.innerHTML=`${n}<div class="tr-toast-msg">${S(t||"")}</div>`}i.toast={show(e,t={}){let r=`toast-${q.nextId++}`,o=nr(),s=document.createElement("div");s.dataset.toastId=r,tt(s,e,t.variant);try{o.appendChild(s)}catch{}let n={id:r,el:s,hideTimer:0};q.items.set(r,n);let a=Number(t.durationMs||0);return a>0&&(n.hideTimer=window.setTimeout(()=>{i.toast.hide(r)},a)),r},update(e,t,r={}){let o=q.items.get(String(e||""));if(!o)return;o.hideTimer&&(window.clearTimeout(o.hideTimer),o.hideTimer=0),tt(o.el,t,r.variant);let s=Number(r.durationMs||0);s>0&&(o.hideTimer=window.setTimeout(()=>{i.toast.hide(e)},s))},hide(e){let t=q.items.get(String(e||""));if(t){t.hideTimer&&(window.clearTimeout(t.hideTimer),t.hideTimer=0);try{t.el.remove()}catch{}q.items.delete(String(e||""))}}};var y={get(e,t=null){try{let r=localStorage.getItem(e);return r===null?t:JSON.parse(r)}catch{return t}},set(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.error("Storage set error:",r)}},remove(e){try{localStorage.removeItem(e)}catch{}},getRaw(e){return localStorage.getItem(e)},setRaw(e,t){localStorage.setItem(e,t)}};i.storage=y;var ir={updatePlatformCount(e){if(!e)return;let t=e.querySelectorAll(".news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)"),r=e.querySelector(".platform-visible-count");r&&(r.textContent=t.length)},updateAllCounts(){document.querySelectorAll(".platform-card").forEach(r=>{this.updatePlatformCount(r)});let e=document.querySelectorAll(".news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)").length,t=document.getElementById("totalNews");t&&(t.textContent=e)}};i.counts=ir;var G={openLink(e){let t=e.dataset.url;t&&window.open(t,"_blank")},isHoverDevice(){return window.matchMedia&&window.matchMedia("(hover: hover)").matches},closeAllPreviews(e){document.querySelectorAll(".news-item.preview").forEach(t=>{e&&t===e||t.classList.remove("preview")})},handleTitleClickV2(e,t){t.stopPropagation();let r=e.closest(".news-item");if(!r)return;let o=r.querySelector(".news-checkbox");if(o&&!o.checked&&(o.checked=!0,typeof window.markAsRead=="function"?window.markAsRead(o):i.readState&&typeof i.readState.markAsRead=="function"&&i.readState.markAsRead(o)),this.isHoverDevice())return;if(r.classList.contains("preview")){r.classList.remove("preview");return}t.preventDefault(),this.closeAllPreviews(r),r.classList.add("preview")},handleTitleKeydownV2(e,t){t.key==="Enter"?this.handleTitleClickV2(e,t):t.key===" "?(t.preventDefault(),this.handleTitleClickV2(e,t)):t.key==="Escape"&&this.closeAllPreviews(null)}};window.handleTitleClickV2=(e,t)=>G.handleTitleClickV2(e,t);window.handleTitleKeydownV2=(e,t)=>G.handleTitleKeydownV2(e,t);window.openLink=e=>G.openLink(e);document.addEventListener("click",e=>{e.target.closest(".news-item")||G.closeAllPreviews(null)});document.addEventListener("touchstart",e=>{e.target.closest(".news-item")||G.closeAllPreviews(null)},{passive:!0});document.addEventListener("keydown",e=>{e.key==="Escape"&&G.closeAllPreviews(null)});i.link=G;var st={searchNews(){let t=(document.getElementById("searchInput")?.value||"").toLowerCase();document.querySelectorAll(".news-item").forEach(r=>{let o=r.textContent.toLowerCase();!t||o.includes(t)?r.classList.remove("search-hidden"):r.classList.add("search-hidden")}),i.counts.updateAllCounts(),i.paging&&typeof i.paging.scheduleAutofillActiveTab=="function"&&i.paging.scheduleAutofillActiveTab()}};window.searchNews=()=>st.searchNews();i.search=st;var nt="trendradar_platform_grid_scroll_v1",lr={getPlatformGridScrollState(){return y.get(nt,{})},setPlatformGridScrollState(e){y.set(nt,e||{})},recordPlatformGridScrollForTab(e,t){if(!e||!t)return;let r=t.scrollLeft||0,o=null,s=0,n=null,a=t.querySelectorAll(".platform-card");for(let d of a)if((d.offsetLeft||0)<=r+1)n=d;else break;n?.dataset?.platform&&(o=n.dataset.platform,s=Math.max(0,r-(n.offsetLeft||0)));let l=this.getPlatformGridScrollState();l[e]={left:r,anchorPlatformId:o,anchorOffsetX:s,updatedAt:Date.now()},this.setPlatformGridScrollState(l)},attachPlatformGridScrollPersistence(){document.querySelectorAll(".tab-pane .platform-grid").forEach(e=>{if(e.dataset.scrollPersistBound==="1")return;e.dataset.scrollPersistBound="1";let t=!1;e.addEventListener("scroll",()=>{e.dataset.trRestoring!=="1"&&(e.dataset.trUserScrolled="1"),!t&&(t=!0,requestAnimationFrame(()=>{t=!1;let r=e.closest(".tab-pane"),o=r?.id?.startsWith("tab-")?r.id.slice(4):null;this.recordPlatformGridScrollForTab(o,e)}))},{passive:!0})})},restoreActiveTabPlatformGridScroll(e){let t=e?.activeTab;if(!e?.preserveScroll||!t)return;let r=this.getPlatformGridScrollState()?.[t],o=Number.isFinite(r?.left)?r.left:Number.isFinite(e.activeTabPlatformGridScrollLeft)?e.activeTabPlatformGridScrollLeft:0,s=typeof r?.anchorPlatformId=="string"&&r.anchorPlatformId?r.anchorPlatformId:e.activeTabPlatformAnchorPlatformId,n=Number.isFinite(r?.anchorOffsetX)?r.anchorOffsetX:Number.isFinite(e.activeTabPlatformAnchorOffsetX)?e.activeTabPlatformAnchorOffsetX:0,a=()=>{let l=document.querySelector(`#tab-${t} .platform-grid`);if(l&&l.dataset.trUserScrolled!=="1"){if(s){let d=null;if(l.querySelectorAll(".platform-card").forEach(u=>{!d&&u.dataset.platform===s&&(d=u)}),d&&d.offsetParent!==null){l.dataset.trRestoring="1",l.scrollLeft=(d.offsetLeft||0)+n,requestAnimationFrame(()=>{try{delete l.dataset.trRestoring}catch{}});return}}l.dataset.trRestoring="1",l.scrollLeft=o,requestAnimationFrame(()=>{try{delete l.dataset.trRestoring}catch{}})}};requestAnimationFrame(()=>{requestAnimationFrame(()=>{a(),setTimeout(a,50),setTimeout(a,200),setTimeout(a,600)})})}};i.scroll=lr;var at="trendradar_feature_badge_v1:",it="trendradar_new_badges_dismissed_v1",Oe={getFeatureBadgeState(e){return y.get(at+e,null)},setFeatureBadgeState(e,t){y.set(at+e,t)},ensureFeatureFirstSeen(e){let t=this.getFeatureBadgeState(e);if(t&&typeof t.firstSeenAt=="number")return t;let r={firstSeenAt:Date.now(),seenAt:null};return this.setFeatureBadgeState(e,r),r},markFeatureSeen(e){let t=this.ensureFeatureFirstSeen(e);t.seenAt||(t.seenAt=Date.now(),this.setFeatureBadgeState(e,t))},shouldShowFeatureBadge(e,t){let r=this.ensureFeatureFirstSeen(e);if(r.seenAt)return!1;let o=(t||7)*24*60*60*1e3;return Date.now()-(r.firstSeenAt||0)<=o},updateNewBadges(){let e=document.getElementById("newBadgeSportsTab");e&&(e.style.display=this.shouldShowFeatureBadge("sports-nba-schedule",7)?"":"none")},getDismissedNewBadges(){let e=y.get(it,{});return{categories:e?.categories||{},platforms:e?.platforms||{}}},setDismissedNewBadges(e){y.set(it,e||{categories:{},platforms:{}})},applyDismissedNewBadges(){let e=this.getDismissedNewBadges();document.querySelectorAll(".new-badge-category").forEach(t=>{let r=t?.dataset?.category;r&&e.categories?.[r]&&(t.style.display="none")}),document.querySelectorAll(".new-badge-platform").forEach(t=>{let r=t?.dataset?.platform;r&&e.platforms?.[r]&&(t.style.display="none")})},dismissNewCategoryBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.categories?.[e]||(t.categories[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-category[data-category="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})},dismissNewPlatformBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.platforms?.[e]||(t.platforms[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-platform[data-platform="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})}};window.dismissNewPlatformBadge=e=>Oe.dismissNewPlatformBadge(e);i.badges=Oe;v(function(){Oe.applyDismissedNewBadges()});var I=20,cr=20,lt=10,dr=8,ur=80,fr=160,ae={PAGE_SIZE:I,getCardPageSize(e){let t=e?.dataset?.pageSize,r=parseInt(t||"",10);return Number.isFinite(r)&&r>0?r:I},setCardPageSize(e,t){if(!e)return;let r=Math.max(I,parseInt(String(t||""),10)||I);e.dataset.pageSize=String(r)},applyPagingToCard(e,t){let r=Array.from(e.querySelectorAll(".news-item")),o=r.length,s=this.getCardPageSize(e);if(o<=s){r.forEach(l=>l.classList.remove("paged-hidden")),e.dataset.pageOffset="0";return}let n=Math.max(0,Math.min(t,o-1)),a=Math.min(n+s,o);r.forEach((l,d)=>{d>=n&&d<a?l.classList.remove("paged-hidden"):l.classList.add("paged-hidden")}),e.dataset.pageOffset=String(n)},initPaging(){document.querySelectorAll(".platform-card").forEach(e=>{this.setCardPageSize(e,I),this.applyPagingToCard(e,0)}),i.counts.updateAllCounts()},refreshPlatform(e){let t=e.closest(".platform-card");if(!t)return;let o=t.querySelectorAll(".news-item").length;if(o<=I)return;let s=parseInt(t.dataset.pageOffset||"0",10),n=s+I>=o?0:s+I;this.applyPagingToCard(t,n),i.counts.updateAllCounts()},getVisibleNewsItems(e){return e?Array.from(e.querySelectorAll(".news-item")).filter(t=>!t.classList.contains("filtered")&&!t.classList.contains("search-hidden")&&!t.classList.contains("paged-hidden")&&!t.classList.contains("read")):[]},shouldAutofillCard(e,t){if(!e||e.classList.contains("platform-empty-hidden"))return!1;let r=this.getVisibleNewsItems(e),o=Number.isFinite(t)?t:lt;if(r.length<o)return!0;let s=r[r.length-1];if(!s)return!0;let n=e.getBoundingClientRect(),a=s.getBoundingClientRect();return!Number.isFinite(n.bottom)||!Number.isFinite(a.bottom)?!1:n.bottom-a.bottom>=ur},autofillCard(e,t={}){if(!e)return!1;let r=Number.isFinite(t.minVisible)?t.minVisible:lt,o=Number.isFinite(t.maxSteps)?t.maxSteps:dr,s=t.force===!0,n=e.querySelectorAll(".news-item").length;if(n<=0)return!1;let a=parseInt(e.dataset.pageOffset||"0",10)||0,l=this.getCardPageSize(e),d=!1;for(let u=0;u<o&&!(!s&&!this.shouldAutofillCard(e,r)||a+l>=n);u++)l=Math.min(n-a,l+cr),this.setCardPageSize(e,l),this.applyPagingToCard(e,a),d=!0;return d&&i.counts.updateAllCounts(),d},autofillForCategory(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r)return!1;let o=!1;return r.querySelectorAll(".platform-card").forEach(s=>{this.autofillCard(s,t)&&(o=!0)}),o},autofillActiveTab(e={}){let r=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;return r?this.autofillForCategory(r,e):!1},scheduleAutofillActiveTab(e={}){clearTimeout(this._autofillTimer),this._autofillTimer=setTimeout(()=>{this._autofillTimer=null,this.autofillActiveTab(e)},120)},attachAutofillScrollListener(){this._autofillScrollBound||(this._autofillScrollBound=!0,window.addEventListener("scroll",()=>{(document.documentElement.scrollHeight||0)-(window.scrollY+window.innerHeight)<=fr&&this.scheduleAutofillActiveTab({force:!0})},{passive:!0}))}};window.refreshPlatform=e=>ae.refreshPlatform(e);i.paging=ae;v(function(){ae.initPaging(),ae.attachAutofillScrollListener(),ae.scheduleAutofillActiveTab({force:!0,maxSteps:1})});var ct="trendradar_read_news_v2",dt="trendradar_read_news",ut="trendradar_show_read_mode",gr=24,O={getReadNews(){return y.get(ct,{})},saveReadNews(e){y.set(ct,e)},getShowReadModePref(){let e=y.getRaw(ut);return e===null?!0:e==="1"},applyShowReadMode(e){e?document.body.classList.add("show-read-mode"):document.body.classList.remove("show-read-mode");let t=document.getElementById("showReadBtn");t&&(e?t.classList.add("active"):t.classList.remove("active"))},migrateOldFormat(){y.getRaw(dt)&&(y.remove(dt),console.log("\u5DF2\u6E05\u9664\u65E7\u7248\u672C\u5DF2\u8BFB\u8BB0\u5F55"))},cleanupExpiredReads(){let e=Date.now(),t=this.getReadNews(),r=!1,o=0;for(let[s,n]of Object.entries(t))if((e-n.readAt)/36e5>=gr){let l=document.querySelector(`[data-news-id="${s}"]`);if(l){l.classList.remove("read");let d=l.querySelector(".news-checkbox");d&&(d.checked=!1)}delete t[s],r=!0,o++}return r&&this.saveReadNews(t),o},markAsRead(e){let t=e.closest(".news-item"),r=t.dataset.newsId,o=t.dataset.newsTitle||"",s=this.getReadNews();e.checked?(t.classList.add("read"),s[r]||(s[r]={title:o.substring(0,50),readAt:Date.now()},this.saveReadNews(s))):(t.classList.remove("read"),delete s[r],this.saveReadNews(s)),i.counts.updatePlatformCount(e.closest(".platform-card")),this.updateReadCount()},updateReadCount(){let e=this.getReadNews(),t=document.getElementById("readCount");t&&(t.textContent=Object.keys(e).length)},restoreReadState(){let e=this.getReadNews();Object.keys(e).forEach(t=>{let r=document.querySelector(`[data-news-id="${t}"]`);if(r){r.classList.add("read");let o=r.querySelector(".news-checkbox");o&&(o.checked=!0)}}),i.counts.updateAllCounts(),this.updateReadCount()},toggleShowRead(){let e=!document.body.classList.contains("show-read-mode");this.applyShowReadMode(e),y.setRaw(ut,e?"1":"0"),i.counts.updateAllCounts()},clearAllRead(){confirm("\u786E\u5B9A\u8981\u6E05\u9664\u6240\u6709\u5DF2\u8BFB\u8BB0\u5F55\u5417\uFF1F\u6240\u6709\u65B0\u95FB\u5C06\u6062\u590D\u663E\u793A\u3002")&&(document.querySelectorAll(".news-item.read").forEach(e=>{e.classList.remove("read");let t=e.querySelector(".news-checkbox");t&&(t.checked=!1)}),this.saveReadNews({}),i.counts.updateAllCounts(),this.updateReadCount())}};window.markAsRead=e=>O.markAsRead(e);window.toggleShowRead=()=>O.toggleShowRead();window.clearAllRead=()=>O.clearAllRead();i.readState=O;v(function(){O.applyShowReadMode(O.getShowReadModePref()),O.migrateOldFormat();let e=O.cleanupExpiredReads();e>0&&console.log(`\u5DF2\u6E05\u7406 ${e} \u6761\u8FC7\u671F\u5DF2\u8BFB\u8BB0\u5F55`),O.restoreReadState(),O.updateReadCount()});var ye="trendradar_categories_config",Me=1,C=null,L=null,H=null,Se=!1,J=!1,N=!0,mr=null,ie="",z=!1;function Fe(e){(!e.categoryFilters||typeof e.categoryFilters!="object")&&(e.categoryFilters={})}function ft(e){let t=e&&typeof e=="object"?e:{};return Array.isArray(t.customCategories)||(t.customCategories=[]),Array.isArray(t.hiddenDefaultCategories)||(t.hiddenDefaultCategories=[]),Array.isArray(t.categoryOrder)||(t.categoryOrder=[]),(!t.platformOrder||typeof t.platformOrder!="object")&&(t.platformOrder={}),Fe(t),t}var A={CATEGORY_CONFIG_KEY:ye,ensureCategoryFilters:Fe,normalizeCategoryConfig:ft,getCategoryConfig(){try{let e=y.getRaw(ye);if(!e)return null;let t=JSON.parse(e);return t.version!==Me?null:ft(t)}catch{return null}},saveCategoryConfig(e){e.version=Me,y.setRaw(ye,JSON.stringify(e)),this.syncConfigToCookie(e)},syncConfigToCookie(e){try{e.customCategories?.length>0||e.hiddenDefaultCategories?.length>0||e.categoryOrder?.length>0?document.cookie="trendradar_has_config=1; path=/; max-age=31536000; SameSite=Lax":document.cookie="trendradar_has_config=; path=/; max-age=0"}catch(t){console.error("Failed to sync config to cookie:",t)}},getDefaultCategoryConfig(){return C||(C={},L={},document.querySelectorAll(".category-tab").forEach(e=>{let t=e.dataset.category,r=e.querySelector(".category-tab-icon")?.textContent?.trim()||"\u{1F4C1}",o=e.querySelector(".category-tab-name")?.textContent?.replace(/NEW$/,"")?.trim()||t;C[t]={id:t,name:o,icon:r,isDefault:!0}}),document.querySelectorAll(".platform-card").forEach(e=>{let t=e.dataset.platform,r=e.querySelector(".platform-name")?.textContent?.trim()?.replace(/ðŸ“±\s*/,"")?.split(" ")[0]||t,s=e.closest(".tab-pane")?.id?.replace("tab-","")||"other";L[t]={id:t,name:r,defaultCategory:s},C[s]&&(C[s].platforms||(C[s].platforms=[]),C[s].platforms.push(t))})),{version:Me,customCategories:[],hiddenDefaultCategories:[],categoryOrder:Object.keys(C),platformOrder:{},categoryFilters:{}}},getMergedCategoryConfig(){let e=this.getDefaultCategoryConfig(),t=this.getCategoryConfig();if(!t)return e;let r={...e,customCategories:t.customCategories||[],hiddenDefaultCategories:t.hiddenDefaultCategories||[],categoryOrder:t.categoryOrder||e.categoryOrder,platformOrder:t.platformOrder||{},categoryFilters:t.categoryFilters||{}};return Object.keys(C).forEach(o=>{r.categoryOrder.includes(o)||r.categoryOrder.push(o)}),r.customCategories.forEach(o=>{r.categoryOrder.includes(o.id)||r.categoryOrder.push(o.id)}),r},getDefaultCategories(){return C},getAllPlatforms(){return L},setDefaultCategories(e){C=e},setAllPlatforms(e){L=e},async openCategorySettings(){let e=document.getElementById("categorySettingsNewBadge");if(e&&(e.style.display="none",localStorage.setItem("category_settings_badge_dismissed","true")),!C||Object.keys(C).length===0)try{let o=await(await fetch("/api/news")).json();o?.categories&&(C={},L={},Object.entries(o.categories).forEach(([s,n])=>{C[s]={id:s,name:n.name,icon:n.icon,isDefault:!0,platforms:Object.keys(n.platforms||{})},Object.entries(n.platforms||{}).forEach(([a,l])=>{L[a]={id:a,name:l.name,defaultCategory:s,data:l}})}))}catch(r){console.error("Failed to fetch categories:",r)}document.getElementById("categorySettingsModal").classList.add("show"),N=!0,mr=null,this.applyCategoryListCollapseState(),this.renderCategoryList(),this.hideEditPanel()},applyCategoryListCollapseState(){let e=document.getElementById("categoryListWrapper");e&&(N?e.classList.add("collapsed"):e.classList.remove("collapsed"));let t=document.getElementById("categoryListToggleBtn");t&&(t.textContent=N?"\u5C55\u5F00\u680F\u76EE\u5217\u8868":"\u6536\u8D77\u680F\u76EE\u5217\u8868")},toggleCategoryListCollapseInSettings(){N=!N,this.applyCategoryListCollapseState()},closeCategorySettings(){document.getElementById("categorySettingsModal").classList.remove("show"),z&&(z=!1,this.applyCategoryConfig())},saveCategorySettings(){let e=document.getElementById("categoryEditPanel");e&&e.classList.contains("show")&&!this.saveCategory()||this.closeCategorySettings()},cancelCategorySettings(){z=!1,document.getElementById("categorySettingsModal").classList.remove("show")},renderCategoryList(){let e=document.getElementById("categoryList"),t=this.getMergedCategoryConfig(),r="";t.categoryOrder.forEach(s=>{let n=t.customCategories.find(u=>u.id===s),a=t.hiddenDefaultCategories.includes(s),l;if(n)l=n;else if(C[s])l=C[s];else return;let d=n?l.platforms?.length||0:C[s]?.platforms?.length||0;r+=`
                <div class="category-item ${n?"custom":""}" data-category-id="${s}" draggable="true">
                    <span class="category-item-drag">\u2630</span>
                    <span class="category-item-name">${l.name}</span>
                    <span class="category-item-platforms">${d} \u4E2A\u5E73\u53F0</span>
                    <label class="category-item-toggle">
                        <input type="checkbox" ${a?"":"checked"} onchange="toggleCategoryVisibility('${s}')">
                        <span class="slider"></span>
                    </label>
                    <div class="category-item-actions">
                        <button class="category-item-btn" onclick="editCategory('${s}')">\u7F16\u8F91</button>
                        ${n?`<button class="category-item-btn delete" onclick="deleteCategory('${s}')">\u5220\u9664</button>`:""}
                    </div>
                </div>
            `}),e.innerHTML=r;let o=document.getElementById("allCategoriesOffToggle");if(o){let s=t.hiddenDefaultCategories||[],n=t.categoryOrder||[];o.checked=n.length>0&&n.every(a=>s.includes(a))}J?e.classList.add("hide-default"):e.classList.remove("hide-default"),this.setupCategoryDragAndDrop()},toggleDefaultCategoryListInSettings(){J=!J,this.renderCategoryList()},toggleAllCategoriesOffInSettings(e){},setupCategoryDragAndDrop(){let e=document.getElementById("categoryList");e.querySelectorAll(".category-item").forEach(r=>{r.addEventListener("dragstart",o=>{r.classList.add("dragging"),o.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging"),this.saveCategoryOrder()}),r.addEventListener("dragover",o=>{o.preventDefault();let s=e.querySelector(".dragging");if(s&&s!==r){let n=r.getBoundingClientRect(),a=n.top+n.height/2;o.clientY<a?e.insertBefore(s,r):e.insertBefore(s,r.nextSibling)}})})},saveCategoryOrder(){let t=document.getElementById("categoryList").querySelectorAll(".category-item"),r=Array.from(t).map(s=>s.dataset.categoryId),o=this.getCategoryConfig()||this.getDefaultCategoryConfig();o.categoryOrder=r,this.saveCategoryConfig(o),z=!0},toggleCategoryVisibility(e){let t=this.getCategoryConfig()||this.getDefaultCategoryConfig(),r=t.hiddenDefaultCategories.indexOf(e);r>=0?t.hiddenDefaultCategories.splice(r,1):t.hiddenDefaultCategories.push(e),this.saveCategoryConfig(t),z=!0,this.renderCategoryList()},showAddCategoryPanel(){Se=!0,H=null,N=!0,this.applyCategoryListCollapseState(),J=!0,document.getElementById("editCategoryName").value="";let e=document.getElementById("platformSearchInput");e&&(e.value=""),ie="",this.renderPlatformSelectList([]),i.filter.setCategoryFilterEditorState("exclude",[]),document.getElementById("categoryEditPanel").classList.add("show")},editCategory(e){Se=!1,H=e;let t=this.getMergedCategoryConfig(),r=t.customCategories.find(l=>l.id===e),o,s;r?(o=r,s=o.platforms||[]):(o=C[e],s=t.platformOrder[e]||o.platforms||[]),document.getElementById("editCategoryName").value=o.name,this.renderPlatformSelectList(s,r);let n=i.filter.getCategoryFilterConfig(e);i.filter.setCategoryFilterEditorState(n.mode,n.keywords),J=!0,N=!0,this.applyCategoryListCollapseState();let a=document.getElementById("platformSearchInput");a&&(a.value=""),ie="",document.getElementById("categoryEditPanel").classList.add("show")},hideEditPanel(){document.getElementById("categoryEditPanel").classList.remove("show"),H=null,Se=!1,J=!1,this.renderCategoryList();let e=document.getElementById("platformSearchInput");e&&(e.value=""),ie=""},cancelEditCategory(){this.hideEditPanel()},renderPlatformSelectList(e,t=!1){let r=document.getElementById("platformSelectList"),o=Object.keys(L),s=[];e.forEach(d=>{L[d]&&s.push(d)}),o.forEach(d=>{s.includes(d)||s.push(d)});let n=(ie||"").trim().toLowerCase(),a=n?s.filter(d=>(L[d]?.name||"").toLowerCase().includes(n)):s,l=n.length>0;r.innerHTML=a.map(d=>{let u=L[d],f=e.includes(d);return`
                <label class="platform-select-item ${f?"selected":""} ${l?"no-drag":""}" data-platform-id="${d}" draggable="${l?"false":"true"}">
                    <span class="drag-handle">\u2630</span>
                    <input type="checkbox" ${f?"checked":""} onchange="togglePlatformSelect('${d}')">
                    <span>${u.name}</span>
                </label>
            `}).join(""),l||this.setupPlatformDragAndDrop()},setPlatformSearchQuery(e){ie=String(e||"");let t=this.getSelectedPlatforms();this.renderPlatformSelectList(t)},bulkSelectPlatforms(e){let t=document.getElementById("platformSelectList");if(!t)return;t.querySelectorAll(".platform-select-item").forEach(o=>{let s=o.querySelector('input[type="checkbox"]');e==="all"?(o.classList.add("selected"),s&&(s.checked=!0)):(e==="none"||e==="clear")&&(o.classList.remove("selected"),s&&(s.checked=!1))})},setupPlatformDragAndDrop(){let e=document.getElementById("platformSelectList");e.querySelectorAll(".platform-select-item").forEach(r=>{r.addEventListener("dragstart",o=>{r.classList.add("dragging"),o.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging")}),r.addEventListener("dragover",o=>{o.preventDefault();let s=e.querySelector(".dragging");if(s&&s!==r){let n=r.getBoundingClientRect(),a=n.top+n.height/2;o.clientY<a?e.insertBefore(s,r):e.insertBefore(s,r.nextSibling)}})})},togglePlatformSelect(e){let t=document.querySelector(`.platform-select-item[data-platform-id="${e}"]`);t&&t.classList.toggle("selected")},getSelectedPlatforms(){let e=document.querySelectorAll(".platform-select-item"),t=[];return e.forEach(r=>{r.classList.contains("selected")&&t.push(r.dataset.platformId)}),t},saveCategory(){let e=document.getElementById("editCategoryName").value.trim(),t="\u{1F4F1}",r=this.getSelectedPlatforms();if(!e)return alert("\u8BF7\u8F93\u5165\u680F\u76EE\u540D\u79F0"),!1;if(r.length===0)return alert("\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5E73\u53F0"),!1;let o=this.getCategoryConfig()||this.getDefaultCategoryConfig();Fe(o);let s=i.filter.getEditingFilterState();if(Se){let n="custom-"+Date.now();o.customCategories.push({id:n,name:e,icon:t,platforms:r,isCustom:!0}),o.categoryOrder.unshift(n),o.categoryFilters[n]={mode:s.mode,keywords:[...s.keywords]}}else if(H){let n=o.customCategories.findIndex(a=>a.id===H);n>=0?o.customCategories[n]={...o.customCategories[n],name:e,icon:t,platforms:r}:o.platformOrder[H]=r,o.categoryFilters[H]={mode:s.mode,keywords:[...s.keywords]}}return this.saveCategoryConfig(o),z=!0,this.hideEditPanel(),this.renderCategoryList(),N=!1,this.applyCategoryListCollapseState(),!0},deleteCategory(e){if(!confirm("\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u81EA\u5B9A\u4E49\u680F\u76EE\u5417\uFF1F"))return;let t=this.getCategoryConfig()||this.getDefaultCategoryConfig();t.customCategories=t.customCategories.filter(r=>r.id!==e),t.categoryOrder=t.categoryOrder.filter(r=>r!==e),delete t.platformOrder[e],this.saveCategoryConfig(t),z=!0,this.renderCategoryList()},resetCategoryConfig(){confirm("\u786E\u5B9A\u8981\u6062\u590D\u9ED8\u8BA4\u680F\u76EE\u914D\u7F6E\u5417\uFF1F\u6240\u6709\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u88AB\u5220\u9664\u3002")&&(y.remove(ye),C=null,L=null,this.renderCategoryList(),this.applyCategoryConfig())},applyCategoryConfig(){i.data.refreshViewerData({preserveScroll:!1})},applyCategoryConfigToData(e){let t=this.getMergedCategoryConfig();C?Object.entries(e).forEach(([d,u])=>{if(!C[d])C[d]={id:d,name:u.name,icon:u.icon,isDefault:!0,platforms:Object.keys(u.platforms||{})};else{C[d].platforms||(C[d].platforms=[]);let f=new Set(C[d].platforms||[]);Object.keys(u.platforms||{}).forEach(c=>{f.has(c)||C[d].platforms.push(c)})}Object.entries(u.platforms||{}).forEach(([f,c])=>{L[f]||(L[f]={id:f,name:c.name,defaultCategory:d,data:c})})}):(C={},L={},Object.entries(e).forEach(([d,u])=>{C[d]={id:d,name:u.name,icon:u.icon,isDefault:!0,platforms:Object.keys(u.platforms||{})},Object.entries(u.platforms||{}).forEach(([f,c])=>{L[f]={id:f,name:c.name,defaultCategory:d,data:c}})}));let r={};Object.values(e).forEach(d=>{Object.entries(d.platforms||{}).forEach(([u,f])=>{r[u]=f})});let o={},s=t.hiddenDefaultCategories||[],n=t.categoryOrder||Object.keys(e),a=t.customCategories||[],l=t.platformOrder||{};return n.forEach(d=>{if(s.includes(d))return;let u=a.find(f=>f.id===d);if(u){let f={};(u.platforms||[]).forEach(c=>{r[c]&&(f[c]=r[c])}),o[d]={name:u.name,icon:"\u{1F4F1}",platforms:f}}else if(e[d]){let f=e[d],c=l[d];if(c&&c.length>0){let m=[],g=new Set;c.forEach(b=>{f.platforms&&f.platforms[b]&&(m.push(b),g.add(b))});let p=[],h=[];Object.keys(f.platforms||{}).forEach(b=>{g.has(b)||(String(b||"").startsWith("rss-")?p.push(b):h.push(b))});let w=p.concat(m,h),_={};w.forEach(b=>{f.platforms&&f.platforms[b]&&(_[b]=f.platforms[b])}),o[d]={...f,platforms:_}}else o[d]=f}}),Object.keys(e).forEach(d=>{!o[d]&&!s.includes(d)&&(o[d]=e[d])}),o}};window.openCategorySettings=()=>A.openCategorySettings();window.closeCategorySettings=()=>A.closeCategorySettings();window.saveCategorySettings=()=>A.saveCategorySettings();window.cancelCategorySettings=()=>A.cancelCategorySettings();window.showAddCategoryPanel=()=>A.showAddCategoryPanel();window.editCategory=e=>A.editCategory(e);window.cancelEditCategory=()=>A.cancelEditCategory();window.saveCategory=()=>A.saveCategory();window.deleteCategory=e=>A.deleteCategory(e);window.resetCategoryConfig=()=>A.resetCategoryConfig();window.toggleCategoryVisibility=e=>A.toggleCategoryVisibility(e);window.toggleCategoryListCollapseInSettings=()=>A.toggleCategoryListCollapseInSettings();window.toggleAllCategoriesOffInSettings=e=>A.toggleAllCategoriesOffInSettings(e);window.togglePlatformSelect=e=>A.togglePlatformSelect(e);window.bulkSelectPlatforms=e=>A.bulkSelectPlatforms(e);window.setPlatformSearchQuery=e=>A.setPlatformSearchQuery(e);i.settings=A;v(function(){let e=A.getCategoryConfig();e&&A.syncConfigToCookie(e)});var gt="trendradar_filter_keywords",mt="trendradar_filter_mode_v1",V=[],we="exclude";function be(e){return e==="include"?"include":"exclude"}var W={normalizeFilterMode:be,getCategoryFilterConfig(e){if(!e)return{mode:"exclude",keywords:[]};let t=i.settings.getMergedCategoryConfig(),r=t.categoryFilters&&t.categoryFilters[e],o=be(r&&r.mode),s=Array.isArray(r&&r.keywords)?r.keywords:[];return{mode:o,keywords:s.map(n=>String(n||"").trim().toLowerCase()).filter(Boolean)}},applyCategoryFilter(e){let t=document.getElementById(`tab-${e}`);if(!t)return;let r=this.getCategoryFilterConfig(e),o=r.mode,s=r.keywords,n=`${o}|${s.join(",")}`,l=(t.dataset?t.dataset.filterSig:null)!==n;t.dataset&&(t.dataset.filterSig=n);let d=t.dataset&&t.dataset.bulkLoading==="1";if(t.querySelectorAll(".news-item").forEach(u=>{let f=(u.textContent||"").toLowerCase(),c=s.length>0?s.some(g=>f.includes(g)):!1;(s.length===0?!1:o==="include"?!c:c)?u.classList.add("filtered"):u.classList.remove("filtered")}),o!=="include"&&t.querySelectorAll(".platform-card").forEach(u=>{u.classList.remove("platform-empty-hidden")}),o==="include"){if(s.length>0)try{if(l&&!d){if(t.querySelectorAll(".platform-card").forEach(u=>{u?.dataset&&(u.dataset.loadedDone="0")}),i.infiniteScroll&&typeof i.infiniteScroll.scheduleBulkLoadCategory=="function")i.infiniteScroll.scheduleBulkLoadCategory(e,{pageSize:40});else if(i.infiniteScroll&&typeof i.infiniteScroll.scheduleEnsureCategoryLoaded=="function"){let u=t.querySelectorAll(".platform-card").length;i.infiniteScroll.scheduleEnsureCategoryLoaded(e,{cap:u,maxPagesPerCard:2})}}}catch{}t.querySelectorAll(".platform-card").forEach(u=>{let f=u?.dataset?.loadedDone==="1",c=!f||u?.dataset?.loading==="1";if(s.length>0&&c){u.classList.add("platform-empty-hidden");return}u.classList.remove("platform-empty-hidden"),u.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length<=0&&f&&u.classList.add("platform-empty-hidden")})}try{let u=t.querySelector(".category-empty-state");if(u)if(o==="include"&&s.length>0){let f=Array.from(t.querySelectorAll(".platform-card")),c=f.length>0&&f.every(g=>g?.dataset?.loadedDone==="1"&&g?.dataset?.loading!=="1"),m=t.querySelectorAll(".platform-card:not(.platform-empty-hidden)").length;u.style.display=c&&m===0?"block":"none"}else u.style.display="none"}catch{}i.counts.updateAllCounts(),i.paging&&typeof i.paging.scheduleAutofillActiveTab=="function"&&i.paging.scheduleAutofillActiveTab()},applyCategoryFilterForActiveTab(){let t=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;t&&this.applyCategoryFilter(t)},setCategoryFilterEditorState(e,t){we=be(e),V=(Array.isArray(t)?t:[]).map(s=>String(s||"").trim().toLowerCase()).filter(Boolean);let r=document.getElementById("categoryFilterModeToggle");r&&(r.checked=we==="include");let o=document.getElementById("categoryFilterInput");o&&(o.value=""),this.renderCategoryFilterTags()},handleCategoryFilterModeToggle(e){we=e&&e.checked?"include":"exclude"},handleCategoryFilterKeypress(e){e.key==="Enter"&&this.addCategoryFilterKeyword()},addCategoryFilterKeyword(){let e=document.getElementById("categoryFilterInput"),t=(e?.value||"").trim().toLowerCase();t&&(V.includes(t)||(V.push(t),this.renderCategoryFilterTags()),e&&(e.value=""))},removeCategoryFilterKeyword(e){V=V.filter(t=>t!==e),this.renderCategoryFilterTags()},renderCategoryFilterTags(){let e=document.getElementById("categoryFilterTags");e&&(e.innerHTML=V.map(t=>`<span class="filter-tag">${S(t)}<span class="filter-remove" onclick="removeCategoryFilterKeyword('${S(t)}')">\xD7</span></span>`).join(""))},getEditingFilterState(){return{mode:we,keywords:[...V]}},migrateLegacyGlobalFilter(){let e=y.getRaw(gt),t=y.getRaw(mt);if(!e&&!t)return;let r=[];try{r=e?JSON.parse(e):[]}catch{r=[]}Array.isArray(r)||(r=[]),r=r.map(l=>String(l||"").trim().toLowerCase()).filter(Boolean);let o=be(t),s=i.settings.getCategoryConfig()||i.settings.getDefaultCategoryConfig();i.settings.ensureCategoryFilters(s),(i.settings.getMergedCategoryConfig().categoryOrder||[]).forEach(l=>{s.categoryFilters[l]||(s.categoryFilters[l]={mode:o,keywords:[...r]})}),i.settings.saveCategoryConfig(s),y.remove(gt),y.remove(mt)}};window.handleCategoryFilterModeToggle=e=>W.handleCategoryFilterModeToggle(e);window.handleCategoryFilterKeypress=e=>W.handleCategoryFilterKeypress(e);window.addCategoryFilterKeyword=()=>W.addCategoryFilterKeyword();window.removeCategoryFilterKeyword=e=>W.removeCategoryFilterKeyword(e);i.filter=W;v(function(){W.migrateLegacyGlobalFilter(),W.applyCategoryFilterForActiveTab()});var le="trendradar_active_tab",Q={TAB_STORAGE_KEY:le,switchTab(e){i.badges.dismissNewCategoryBadge(e);let t=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(e)):String(e),r=document.querySelector(`.category-tab[data-category="${t}"]`),o=document.getElementById(`tab-${e}`);if(!r||!o){let s=document.querySelector(".category-tab");s?.dataset?.category&&s.dataset.category!==String(e)?this.switchTab(s.dataset.category):y.remove(le);return}document.querySelectorAll(".category-tab").forEach(s=>s.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".tab-pane").forEach(s=>s.classList.remove("active")),o.classList.add("active"),y.setRaw(le,e),i.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e}),e==="sports"&&(i.badges.markFeatureSeen("sports-nba-schedule"),i.badges.updateNewBadges()),i.filter.applyCategoryFilter(e),i.paging&&typeof i.paging.scheduleAutofillActiveTab=="function"&&i.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1});try{let s=!!o.querySelector(".news-item"),n=!!o.querySelector(".news-placeholder");!s&&n&&(i.infiniteScroll&&typeof i.infiniteScroll.scheduleBulkLoadCategory=="function"?i.infiniteScroll.scheduleBulkLoadCategory(e):i.infiniteScroll&&typeof i.infiniteScroll.scheduleEnsureCategoryLoaded=="function"&&i.infiniteScroll.scheduleEnsureCategoryLoaded(e))}catch{}},restoreActiveTab(){let e=y.getRaw(le);e&&document.querySelector(`.category-tab[data-category="${e}"]`)&&this.switchTab(e)},getActiveTabId(){return y.getRaw(le)||document.querySelector(".category-tab.active")?.dataset?.category||null},restoreActiveTabPlatformGridScroll(e){i.scroll.restoreActiveTabPlatformGridScroll(e)},attachPlatformGridScrollPersistence(){i.scroll.attachPlatformGridScrollPersistence()}};window.switchTab=e=>Q.switchTab(e);i.tabs=Q;v(function(){Q.restoreActiveTab(),Q.attachPlatformGridScrollPersistence();let e=Q.getActiveTabId();e&&Q.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e})});var Be="trendradar_active_tab",pt=20,De=!1,ht=0,Z=null,Ce={formatUpdatedAt:ne,snapshotViewerState(){let e=y.getRaw(Be)||document.querySelector(".category-tab.active")?.dataset?.category||null,t={};document.querySelectorAll(".platform-card").forEach(a=>{let l=a.dataset.platform;l&&(t[l]=parseInt(a.dataset.pageOffset||"0",10)||0)});let r=e?document.querySelector(`#tab-${e} .platform-grid`):null,o=r&&r.scrollLeft||0,s=null,n=0;if(r){let a=r.scrollLeft||0,l=null,d=r.querySelectorAll(".platform-card");for(let u of d)if((u.offsetLeft||0)<=a+1)l=u;else break;l?.dataset?.platform&&(s=l.dataset.platform,n=Math.max(0,a-(l.offsetLeft||0)))}return e&&r&&i.scroll.recordPlatformGridScrollForTab(e,r),{activeTab:e,pagingOffsets:t,activeTabPlatformGridScrollLeft:o,activeTabPlatformAnchorPlatformId:s,activeTabPlatformAnchorOffsetX:n,showReadMode:document.body.classList.contains("show-read-mode"),scrollY:window.scrollY||0,searchText:document.getElementById("searchInput")?.value||""}},renderViewerFromData(e,t){let r=document.querySelector(".tab-content-area"),o=document.querySelector(".category-tabs");if(!o||!r)return;let s=i.settings.applyCategoryConfigToData(e?.categories||{}),n=t&&typeof t.activeTab=="string"?t.activeTab:null,a=Object.keys(s||{})[0]||null,l=n||a,d=Object.entries(s).map(([h,w])=>{let _=S(w?.icon||""),b=S(w?.name||h),F=`${w?.is_new?`<span class="new-badge new-badge-category" data-category="${S(h)}">NEW</span>`:""}${h==="sports"?'<span class="new-badge" id="newBadgeSportsTab" style="display:none;">NEW</span>':""}`;return`
            <div class="category-tab" data-category="${S(h)}" draggable="false" onclick="switchTab('${S(h)}')">
                <span class="category-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F" draggable="true">\u2630</span>
                <div class="category-tab-icon">${_}</div>
                <div class="category-tab-name">${b}${F}</div>
            </div>`}).join(""),u=Object.entries(s).map(([h,w])=>{let _=!!l&&String(h)===String(l),b=w?.platforms||{},T=Object.entries(b).map(([E,F])=>{let D=S(F?.name||E),Y=F?.is_new?`<span class="new-badge new-badge-platform" data-platform="${S(E)}">NEW</span>`:"",Ue=Array.isArray(F?.news)?F.news:[],Xe=Ue.length,Ye=_?Math.min(Xe,pt):0,Je=E&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[E])?t.pagingOffsets[E]:0,Kt=Ue.slice(0,Ye).map((B,Pe)=>{let Ut=S(B?.stable_id||""),Qe=S(B?.display_title||B?.title||""),Xt=S(B?.url||""),Ze=S(B?.meta||""),Yt=String(E||"").startsWith("rss-"),et=!!B?.is_cross_platform,Jt=Array.isArray(B?.cross_platforms)?B.cross_platforms:[],Qt=S(Jt.join(", ")),Zt=S(B?.cross_platform_count??""),er=et?`<span class="cross-platform-badge" title="\u540C\u65F6\u51FA\u73B0\u5728: ${Qt}">\u{1F525} ${Zt}</span>`:"",tr=et?"cross-platform":"",rr=`<span class="news-index">${String(Pe+1)}</span>`,or=Pe<Je||Pe>=Je+pt?" paged-hidden":"",sr=Ze&&!Yt?`<div class="news-subtitle">${Ze}</div>`:"";return`
                        <li class="news-item${or}" data-news-id="${Ut}" data-news-title="${Qe}">
                            <div class="news-item-content">
                                <input type="checkbox" class="news-checkbox" onchange="markAsRead(this)" title="\u6807\u8BB0\u5DF2\u8BFB">
                                ${rr}
                                <a class="news-title ${tr}" href="${Xt||"#"}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                                    ${Qe}
                                    ${er}
                                </a>
                            </div>
                            ${sr}
                        </li>`}).join("")||(_?"":'<li class="news-placeholder" aria-hidden="true">\u5F85\u52A0\u8F7D...</li>');return`
                <div class="platform-card" data-platform="${S(E)}" data-total-count="${String(Xe)}" data-loaded-count="${String(Ye)}" draggable="false">
                    <div class="platform-header">
                        <span class="platform-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u5E73\u53F0\u987A\u5E8F" draggable="true">\u2630</span>
                        <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('${S(E)}')">\u{1F4F1} ${D}${Y}</div>
                        <div class="platform-header-actions"></div>
                    </div>
                    <ul class="news-list">${Kt}
                    </ul>
                    <div class="news-load-sentinel" aria-hidden="true"></div>
                </div>`}).join("");return`
            <div class="tab-pane" id="tab-${S(h)}">
                <div class="platform-grid">${T}
                </div>
                <div class="category-empty-state" style="display:none;" aria-hidden="true">\u6CA1\u6709\u5339\u914D\u5185\u5BB9\uFF0C\u8BF7\u8C03\u6574\u5173\u952E\u8BCD\u6216\u5207\u6362\u6A21\u5F0F</div>
            </div>`}).join("");o.innerHTML=d,r.innerHTML=u;try{let h=o.querySelectorAll(".category-tab").length;o.classList.toggle("compact",h>8)}catch{}let f=document.getElementById("updatedAt");f&&e?.updated_at&&(f.textContent=ne(e.updated_at));let c=t&&typeof t.activeTab=="string"?t.activeTab:null;if(c){let h=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(c):c;if(document.querySelector(`.category-tab[data-category="${h}"]`))i.tabs.switchTab(c);else{let _=document.querySelector(".category-tab");_?.dataset?.category?i.tabs.switchTab(_.dataset.category):y.remove(Be)}}else{let h=document.querySelector(".category-tab");h?.dataset?.category?i.tabs.switchTab(h.dataset.category):y.remove(Be)}let m=typeof t?.showReadMode=="boolean"?t.showReadMode:i.readState.getShowReadModePref();i.readState.applyShowReadMode(m);let g=document.getElementById("searchInput");g&&typeof t?.searchText=="string"&&(g.value=t.searchText),i.search.searchNews(),i.filter.applyCategoryFilterForActiveTab(),i.readState.restoreReadState(),document.querySelectorAll(".platform-card").forEach(h=>{let w=h.dataset.platform,_=w&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[w])?t.pagingOffsets[w]:0;i.paging.setCardPageSize(h,i.paging.PAGE_SIZE),i.paging.applyPagingToCard(h,_)}),i.counts.updateAllCounts(),i.readState.updateReadCount(),i.scroll.restoreActiveTabPlatformGridScroll(t),i.scroll.attachPlatformGridScrollPersistence();let p=document.getElementById("early-hide");p&&p.remove(),document.body.classList.add("categories-ready"),i.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1});try{i.infiniteScroll&&typeof i.infiniteScroll.attach=="function"&&i.infiniteScroll.attach()}catch{}},async refreshViewerData(e={}){let t=e.preserveScroll!==!1;if(De){Z?Z.preserveScroll=Z.preserveScroll&&t:Z={preserveScroll:t};return}De=!0;try{let r=this.snapshotViewerState();r.preserveScroll=t;let n=await(await fetch("/api/news")).json();try{let a=i.subscription?.getSubscriptions?i.subscription.getSubscriptions():[];if(Array.isArray(a)&&a.length>0){let d=a.slice(0,25),u=d.map(m=>String(m?.source_id||m?.rss_source_id||"").trim()).filter(Boolean);if(u.length>0)try{fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:u,priority:"normal"})}).catch(()=>{})}catch{}let f=await fetch("/api/subscriptions/rss-news",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscriptions:d})}),c=await f.json();if(f.ok&&c&&typeof c=="object"){let m=n&&typeof n=="object"&&n.categories?n.categories:{},g=c&&typeof c=="object"&&c.categories?c.categories:{};n={...n,categories:{...m,...g}}}}}catch(a){console.error("rss merge error:",a)}this.renderViewerFromData(n,r),r.preserveScroll&&(window.scrollTo({top:r.scrollY,behavior:"auto"}),i.scroll.restoreActiveTabPlatformGridScroll(r)),ht=Date.now()}catch(r){console.error("refreshViewerData error:",r)}finally{De=!1;let r=Z;Z=null,r&&this.refreshViewerData({preserveScroll:r.preserveScroll})}},async fetchData(){let e=document.getElementById("fetchBtn"),t=document.getElementById("progressContainer"),r=document.getElementById("progressBar"),o=document.getElementById("fetchStatus");e.classList.add("loading"),e.disabled=!0,t.classList.add("show"),r.classList.add("indeterminate"),o.className="fetch-status",o.textContent="\u6B63\u5728\u83B7\u53D6\u6570\u636E...";try{let n=await(await fetch("/api/fetch",{method:"POST"})).json();r.classList.remove("indeterminate"),n.success?(r.style.width="100%",o.className="fetch-status success",o.textContent=`\u2705 ${n.platforms} \u4E2A\u5E73\u53F0\uFF0C${n.news_count} \u6761\u65B0\u95FB`,setTimeout(()=>this.refreshViewerData({preserveScroll:!0}),300)):(r.style.width="0%",o.className="fetch-status error",o.textContent=`\u274C ${n.error}`)}catch(s){r.classList.remove("indeterminate"),r.style.width="0%",o.className="fetch-status error",o.textContent=`\u274C ${s.message}`}finally{e.classList.remove("loading"),e.disabled=!1,setTimeout(()=>{t.classList.remove("show"),r.style.width="0%"},5e3)}},setupAjaxAutoRefresh(){setInterval(()=>{document.visibilityState!=="visible"||Date.now()-ht<295e3||this.refreshViewerData({preserveScroll:!0})},5e3),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&this.refreshViewerData({preserveScroll:!0})})}};window.fetchData=()=>Ce.fetchData();window.refreshViewerData=e=>Ce.refreshViewerData(e);i.data=Ce;v(function(){let e=document.getElementById("updatedAt");e&&e.textContent&&(e.textContent=ne(e.textContent)),Ce.setupAjaxAutoRefresh()});var ve=20,pr="240px 0px 240px 0px",R=40,ce=null,qe=!1,de=0,hr=1,yt=0,yr=600,_e=null,ue=null,Sr=160,Ee=null,fe=null,wr=250;function br(){return document.querySelector(".category-tabs .category-tab.active")?.dataset?.category||null}function Ie(e,t){try{let r=e?.querySelector?.(".news-list");if(!r)return;let o=r.querySelector(".news-placeholder");o||(o=document.createElement("li"),o.className="news-placeholder",o.setAttribute("aria-hidden","true"),r.appendChild(o)),o.textContent=String(t||"")}catch{}}function St(){if(clearTimeout(_e),_e=null,ue){try{ue.abort()}catch{}ue=null}try{document.querySelectorAll(".platform-card").forEach(e=>{let t=e?.querySelector?.(".news-list");if(!t)return;let r=t.querySelector(".news-placeholder");!r||t.querySelectorAll(".news-item").length>0||(r.textContent||"").includes("\u52A0\u8F7D\u4E2D")&&(r.textContent="\u5F85\u52A0\u8F7D...")})}catch{}}function Cr(e,t={}){St(),ue=new AbortController;let r=ue.signal;_e=setTimeout(()=>{_e=null,Ct(e,{...t,signal:r}).catch(()=>{})},Sr)}function wt(){if(clearTimeout(Ee),Ee=null,fe){try{fe.abort()}catch{}fe=null}}function vr(e,t,r){let o=document.createElement("li");o.className="news-item",o.dataset.newsId=String(e?.stable_id||""),o.dataset.newsTitle=String(e?.display_title||e?.title||"");let s=document.createElement("div");s.className="news-item-content";let n=document.createElement("input");n.type="checkbox",n.className="news-checkbox",n.title="\u6807\u8BB0\u5DF2\u8BFB",n.addEventListener("change",()=>{try{window.markAsRead(n)}catch{}});let a=document.createElement("span");a.className="news-index",a.textContent=String(t);let l=document.createElement("a");if(l.className="news-title",e?.is_cross_platform&&l.classList.add("cross-platform"),l.href=String(e?.url||"#"),l.target="_blank",l.rel="noopener noreferrer",l.setAttribute("onclick","handleTitleClickV2(this, event)"),l.setAttribute("onauxclick","handleTitleClickV2(this, event)"),l.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),l.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),l.textContent=String(e?.display_title||e?.title||""),e?.is_cross_platform){let f=Array.isArray(e?.cross_platforms)?e.cross_platforms:[],c=document.createElement("span");c.className="cross-platform-badge",c.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${f.join(", ")}`,c.textContent=`\u{1F525} ${String(e?.cross_platform_count??"")}`,l.appendChild(document.createTextNode(" ")),l.appendChild(c)}s.appendChild(n),s.appendChild(a),s.appendChild(l),o.appendChild(s);let d=String(e?.meta||"").trim(),u=String(r||"").startsWith("rss-");if(d&&!u){let f=document.createElement("div");f.className="news-subtitle",f.textContent=d,o.appendChild(f)}return _t(o),vt(o),o}async function bt(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r||!r.classList.contains("active"))return;try{r.dataset&&(r.dataset.bulkLoading="1")}catch{}let o=t.signal;if(o?.aborted){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}let s=null;try{i.filter&&typeof i.filter.getCategoryFilterConfig=="function"&&(s=i.filter.getCategoryFilterConfig(e))}catch{s=null}let n=s?.mode||"exclude",a=Array.isArray(s?.keywords)?s.keywords:[],l=Number.isFinite(t.pageSize)?t.pageSize:R,d=Math.min(Math.max(1,l),R),u=Array.from(r.querySelectorAll(".platform-card")),f=u.map(g=>(g?.dataset?.platform||"").trim()).filter(Boolean);if(f.length<=0){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}for(let g of u)g&&(g.dataset.loading="1",Ie(g,"\u52A0\u8F7D\u4E2D..."));let c;try{let g=await fetch(`/api/news/pages?page_size=${encodeURIComponent(String(d))}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({platform_ids:f}),signal:o});if(!g.ok)return;c=await g.json()}catch{return}finally{try{r.dataset&&delete r.dataset.bulkLoading}catch{}}let m=c&&c.platforms||{};for(let g of u){if(o?.aborted)return;let p=(g?.dataset?.platform||"").trim();if(!p)continue;let h=g.querySelector(".news-list");if(!h)continue;h.querySelectorAll(".news-placeholder").forEach(T=>T.remove()),h.querySelectorAll(".news-item").forEach(T=>T.remove());let w=m[p]||{},_=Array.isArray(w.items)?w.items:[];for(let T=0;T<_.length;T++)h.appendChild(vr(_[T],T+1,p));let b=h.querySelectorAll(".news-item").length;g.dataset.loadedCount=String(b),g.dataset.hasMore=w.has_more&&b<R?"1":"0",g.dataset.loading="0",g.dataset.loadedDone="1";try{if(i.paging){let T=Math.min(R,b);i.paging.setCardPageSize(g,T),i.paging.applyPagingToCard(g,0)}}catch{}i.counts?.updatePlatformCount&&i.counts.updatePlatformCount(g)}i.counts?.updateAllCounts&&i.counts.updateAllCounts();try{i.filter&&typeof i.filter.applyCategoryFilter=="function"&&i.filter.applyCategoryFilter(e)}catch{}}function _r(e,t={}){wt(),fe=new AbortController;let r=fe.signal;Ee=setTimeout(()=>{Ee=null,bt(e,{...t,signal:r}).catch(()=>{})},wr)}async function Ct(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r||!r.classList.contains("active"))return;let o=t.signal;if(o?.aborted)return;let s=null;try{i.filter&&typeof i.filter.getCategoryFilterConfig=="function"&&(s=i.filter.getCategoryFilterConfig(e))}catch{s=null}let n=s?.mode||"exclude",a=Array.isArray(s?.keywords)?s.keywords:[],l=n==="include"&&a.length>0,d=Number.isFinite(t.maxPagesPerCard)?t.maxPagesPerCard:l?2:1,u=Number.isFinite(t.cap)?t.cap:l?10:4,f=Array.from(r.querySelectorAll(".platform-card")).slice(0,Math.max(0,u));for(let c of f){if(o?.aborted)return;if(!c)continue;let m=c.querySelector(".news-list");if(!m)continue;let g=m.querySelectorAll(".news-item").length;if(l&&g>0){c.dataset.loadedDone="1";continue}if(!l&&g>0){c.dataset.loadedDone="1";continue}let p=ve;for(let h=0;h<d;h++){if(o?.aborted)return;Ie(c,"\u52A0\u8F7D\u4E2D..."),await Et(c,Math.min(p,R),{signal:o});try{i.paging&&(i.paging.setCardPageSize(c,Math.min(p,R)),i.paging.applyPagingToCard(c,0))}catch{}let w=c.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length;if(!l||w>0||!(c.dataset.hasMore!=="0"))break;p+=ve}c.dataset.loadedDone="1"}i.counts?.updateAllCounts&&i.counts.updateAllCounts();try{i.filter&&typeof i.filter.applyCategoryFilter=="function"&&i.filter.applyCategoryFilter(e)}catch{}}function vt(e){try{let t=br();if(!t||!i.filter?.getCategoryFilterConfig)return;let r=i.filter.getCategoryFilterConfig(t),o=r?.mode||"exclude",s=Array.isArray(r?.keywords)?r.keywords:[],n=(e?.textContent||"").toLowerCase(),a=s.length>0?s.some(d=>n.includes(d)):!1;(s.length===0?!1:o==="include"?!a:a)?e.classList.add("filtered"):e.classList.remove("filtered")}catch{}}function _t(e){try{let t=e?.dataset?.newsId;if(!t||!i.readState?.getReadNews||!(i.readState.getReadNews()||{})[t])return;e.classList.add("read");let o=e.querySelector(".news-checkbox");o&&(o.checked=!0)}catch{}}async function Et(e,t,r={}){let o=(e?.dataset?.platform||"").trim();if(!o)return{ok:!1,hasMore:!1};let s=r.signal;if(s?.aborted)return{ok:!1,hasMore:!0};if(e.dataset.loading==="1")return{ok:!1,hasMore:!0};if(e.dataset.hasMore==="0")return{ok:!1,hasMore:!1};let n=e.querySelector(".news-list");if(!n)return{ok:!1,hasMore:!1};n.querySelectorAll(".news-placeholder").forEach(l=>l.remove()),t=Math.min(Math.max(0,t||0),R);let a=n.querySelectorAll(".news-item").length;if(a>=R)return e.dataset.hasMore="0",{ok:!1,hasMore:!1};if(a>=t)return{ok:!0,hasMore:!0};e.dataset.loading="1";try{if(de>=hr)return{ok:!1,hasMore:!0};de+=1;let l=Math.min(ve,Math.max(0,R-a));if(l<=0)return e.dataset.hasMore="0",{ok:!1,hasMore:!1};let d=`/api/news/page?platform_id=${encodeURIComponent(o)}&offset=${encodeURIComponent(String(a))}&page_size=${encodeURIComponent(String(l))}`,u;try{u=await fetch(d,{signal:s})}catch(g){if(s?.aborted||g&&g.name==="AbortError")return e.querySelectorAll(".news-item").length<=0&&Ie(e,"\u5F85\u52A0\u8F7D..."),{ok:!1,hasMore:!0};throw g}if(!u.ok)return{ok:!1,hasMore:!0};let f=await u.json(),c=Array.isArray(f?.items)?f.items:[],m=!!f?.has_more;(!m||a+c.length>=R)&&(e.dataset.hasMore="0");for(let g=0;g<c.length;g++){let p=c[g]||{},h=a+g+1,w=document.createElement("li");w.className="news-item",w.dataset.newsId=String(p.stable_id||""),w.dataset.newsTitle=String(p.display_title||p.title||"");let _=document.createElement("div");_.className="news-item-content";let b=document.createElement("input");b.type="checkbox",b.className="news-checkbox",b.title="\u6807\u8BB0\u5DF2\u8BFB",b.addEventListener("change",()=>{try{window.markAsRead(b)}catch{}});let T=document.createElement("span");T.className="news-index",T.textContent=String(h);let E=document.createElement("a");if(E.className="news-title",p.is_cross_platform&&E.classList.add("cross-platform"),E.href=String(p.url||"#"),E.target="_blank",E.rel="noopener noreferrer",E.setAttribute("onclick","handleTitleClickV2(this, event)"),E.setAttribute("onauxclick","handleTitleClickV2(this, event)"),E.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),E.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),E.textContent=String(p.display_title||p.title||""),p.is_cross_platform){let D=Array.isArray(p.cross_platforms)?p.cross_platforms:[],Y=document.createElement("span");Y.className="cross-platform-badge",Y.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${D.join(", ")}`,Y.textContent=`\u{1F525} ${String(p.cross_platform_count??"")}`,E.appendChild(document.createTextNode(" ")),E.appendChild(Y)}_.appendChild(b),_.appendChild(T),_.appendChild(E),w.appendChild(_);let F=String(p.meta||"").trim();if(F){let D=document.createElement("div");D.className="news-subtitle",D.textContent=F,w.appendChild(D)}n.appendChild(w),_t(w),vt(w)}return e.dataset.loadedCount=String(n.querySelectorAll(".news-item").length),i.counts?.updatePlatformCount&&i.counts.updatePlatformCount(e),{ok:!0,hasMore:m}}finally{de=Math.max(0,de-1),e.dataset.loading="0"}}async function Er(e){if(!e||!i.paging)return;let t=e.closest(".tab-pane");if(t&&!t.classList.contains("active"))return;let r=Date.now();if(r<yt)return;yt=r+yr;let o=parseInt(e.dataset.pageOffset||"0",10)||0,s=i.paging.getCardPageSize(e),n=Math.max(0,R-o);if(s>=n){e.dataset.hasMore="0";return}let a=Math.min(s+ve,n),l=o+a;await Et(e,l);let d=e.querySelectorAll(".news-item").length,u=Math.min(Math.max(s,a),Math.max(d-o,s)),f=Math.min(u,n);i.paging.setCardPageSize(e,f),i.paging.applyPagingToCard(e,o),i.counts?.updateAllCounts&&i.counts.updateAllCounts()}function At(){if(ce){try{ce.disconnect()}catch{}ce=null}ce=new IntersectionObserver(e=>{for(let t of e){if(!t.isIntersecting||!qe||de>0)continue;let o=t.target?.closest?.(".platform-card");o&&Er(o).catch(()=>{})}},{root:null,rootMargin:pr,threshold:.01}),document.querySelectorAll(".news-load-sentinel").forEach(e=>ce.observe(e))}i.infiniteScroll={attach:At,ensureCategoryLoaded:Ct,scheduleEnsureCategoryLoaded:Cr,cancelEnsureCategoryLoaded:St,bulkLoadCategory:bt,scheduleBulkLoadCategory:_r,cancelBulkLoadCategory:wt};v(function(){try{window.addEventListener("scroll",()=>{qe=!0},{passive:!0,once:!0})}catch{}setTimeout(()=>{qe=!0},1200),At()});function Ne(e){let r=e?.closest?.(".tab-pane")?.id||"";return r.startsWith("tab-")?r.slice(4):null}function Ar(e,t){if(!e||!Array.isArray(t))return;let r=i.settings.getCategoryConfig()||i.settings.getDefaultCategoryConfig(),o=i.settings.normalizeCategoryConfig(r);if((i.settings.getMergedCategoryConfig().customCategories||[]).find(a=>a.id===e)){let a=(o.customCategories||[]).findIndex(l=>l.id===e);a>=0&&(o.customCategories[a]={...o.customCategories[a],platforms:t})}else(!o.platformOrder||typeof o.platformOrder!="object")&&(o.platformOrder={}),o.platformOrder[e]=t;i.settings.saveCategoryConfig(o)}var Tt={_draggingCard:null,_draggingPlatformId:null,_originGrid:null,_originCategoryId:null,_autoScrollRaf:null,_autoScrollGrid:null,_autoScrollDir:0,_autoScrollSpeed:0,attach(){if(this._attached)return;this._attached=!0;let e=40,t=18,r=()=>{this._autoScrollRaf&&cancelAnimationFrame(this._autoScrollRaf),this._autoScrollRaf=null,this._autoScrollGrid=null,this._autoScrollDir=0,this._autoScrollSpeed=0},o=()=>{if(this._autoScrollRaf)return;let n=()=>{if(!this._autoScrollGrid||!this._autoScrollDir||!this._autoScrollSpeed){r();return}let a=this._autoScrollGrid,l=Math.max(0,(a.scrollWidth||0)-(a.clientWidth||0));if(l<=0){r();return}let d=Math.max(0,Math.min(l,(a.scrollLeft||0)+this._autoScrollDir*this._autoScrollSpeed));a.scrollLeft=d,this._autoScrollRaf=requestAnimationFrame(n)};this._autoScrollRaf=requestAnimationFrame(n)},s=(n,a)=>{if(!this._draggingCard||!a){r();return}if(Math.max(0,(a.scrollWidth||0)-(a.clientWidth||0))<=0){r();return}let d=a.getBoundingClientRect(),u=n.clientX,f=u-d.left,c=d.right-u,m=0,g=0;if(f>=0&&f<=e)m=-1,g=f;else if(c>=0&&c<=e)m=1,g=c;else{r();return}let p=Math.max(0,Math.min(1,(e-g)/e)),h=Math.max(1,Math.round(p*p*t));this._autoScrollGrid=a,this._autoScrollDir=m,this._autoScrollSpeed=h,o()};document.addEventListener("dragstart",n=>{let a=n.target?.closest?.(".platform-drag-handle");if(!a)return;let l=a.closest(".platform-card"),d=a.closest(".platform-grid"),u=Ne(d),f=l?.dataset?.platform||null;if(!(!l||!d||!u||!f)){this._draggingCard=l,this._draggingPlatformId=f,this._originGrid=d,this._originCategoryId=u,l.classList.add("dragging"),n.dataTransfer.effectAllowed="move";try{n.dataTransfer.setData("text/plain",f)}catch{}}},!0),document.addEventListener("dragend",n=>{let a=n.target?.closest?.(".platform-drag-handle");if(!a)return;let l=a.closest(".platform-card"),d=a.closest(".platform-grid"),u=Ne(d);if(!l||!d||!u){this._draggingCard&&this._draggingCard.classList.remove("dragging"),this._draggingCard=null,this._draggingPlatformId=null,this._originGrid=null,this._originCategoryId=null,r();return}let f=Array.from(d.querySelectorAll(".platform-card")).map(c=>c.dataset.platform).filter(Boolean);Ar(u,f),l.classList.remove("dragging"),this._draggingCard=null,this._draggingPlatformId=null,this._originGrid=null,this._originCategoryId=null,r()},!0),document.addEventListener("dragover",n=>{let a=n.target?.closest?.(".platform-grid");if(!a||!this._draggingCard||this._originGrid&&a!==this._originGrid)return;let l=Ne(a);if(!l||this._originCategoryId&&l!==this._originCategoryId)return;n.preventDefault(),s(n,a);let d=n.target?.closest?.(".platform-card");if(!d||d===this._draggingCard)return;let u=Array.from(a.querySelectorAll(".platform-card")),f=u.indexOf(this._draggingCard),c=u.indexOf(d);f<0||c<0||f===c||(f<c?a.insertBefore(this._draggingCard,d.nextSibling):a.insertBefore(this._draggingCard,d))},!0),document.addEventListener("drop",n=>{let a=n.target?.closest?.(".platform-grid");!a||!this._draggingCard||this._originGrid&&a!==this._originGrid||(n.preventDefault(),r())},!0)}};i.platformReorder=Tt;v(()=>{Tt.attach()});function Tr(e){return e?Array.from(e.querySelectorAll(".category-tab")).map(t=>String(t?.dataset?.category||"").trim()).filter(Boolean):[]}function Lr(e){if(!Array.isArray(e)||e.length===0)return;let t=i.settings.getCategoryConfig()||i.settings.getDefaultCategoryConfig(),r=i.settings.normalizeCategoryConfig(t),o=i.settings.getMergedCategoryConfig(),s=Array.isArray(o?.categoryOrder)&&o.categoryOrder.length>0?o.categoryOrder.slice():e.slice(),n=new Set(e),a=0,l=s.map(d=>{let u=String(d||"").trim();if(!u||!n.has(u))return u;let f=e[a];return a+=1,f});r.categoryOrder=l,i.settings.saveCategoryConfig(r)}function xr(e){let t=document.querySelector(".tab-content-area");if(!t)return;let r=new Map;t.querySelectorAll(".tab-pane").forEach(s=>{let n=String(s?.id||"");n.startsWith("tab-")&&r.set(n.slice(4),s)});let o=document.createDocumentFragment();for(let s of e){let n=r.get(s);n&&o.appendChild(n)}for(let[s,n]of r.entries())e.includes(s)||o.appendChild(n);t.appendChild(o)}function Lt(){let e=document.querySelector(".category-tabs");e&&e.querySelectorAll(".category-tab").forEach(t=>{try{t.setAttribute("draggable","false");let r=t.querySelector(":scope > .category-drag-handle");r?r.setAttribute("draggable","true"):(r=document.createElement("span"),r.className="category-drag-handle",r.setAttribute("title","\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F"),r.setAttribute("draggable","true"),r.textContent="\u2630",t.insertBefore(r,t.firstChild))}catch{}})}function kr(){let e=document.querySelector(".category-tabs");if(e)try{new MutationObserver(()=>{Lt()}).observe(e,{childList:!0,subtree:!0})}catch{}}function Rr(){let e=document.body;if(!e)return;let t=0,r=0,o=!1,s=()=>{t&&(window.clearTimeout(t),t=0),r&&(window.clearTimeout(r),r=0)},n=()=>{o=!1,e.classList.remove("category-tabs-drag-mode")};document.addEventListener("pointerdown",l=>{!l.target?.closest?.(".category-tabs")||!l.target?.closest?.(".category-tab")||l.target?.closest?.(".category-drag-handle")||(s(),t=window.setTimeout(()=>{o=!0,e.classList.add("category-tabs-drag-mode"),r=window.setTimeout(()=>{n()},2500)},380))},!0);let a=()=>{s(),o&&n()};document.addEventListener("pointerup",a,!0),document.addEventListener("pointercancel",a,!0),document.addEventListener("scroll",a,!0)}var xt={_attached:!1,_draggingTab:null,_originTabsEl:null,attach(){this._attached||(this._attached=!0,Lt(),kr(),Rr(),document.addEventListener("click",e=>{e.target?.closest?.(".category-drag-handle")&&(e.preventDefault(),e.stopPropagation())},!0),document.addEventListener("dragstart",e=>{let t=e.target?.closest?.(".category-drag-handle");if(!t)return;let r=t.closest(".category-tab"),o=t.closest(".category-tabs"),s=r?.dataset?.category;if(!(!r||!o||!s)){this._draggingTab=r,this._originTabsEl=o,r.classList.add("dragging"),e.dataTransfer.effectAllowed="move";try{e.dataTransfer.setData("text/plain",String(s))}catch{}}},!0),document.addEventListener("dragover",e=>{let t=e.target?.closest?.(".category-tabs");if(!t||!this._draggingTab||this._originTabsEl&&t!==this._originTabsEl)return;let r=e.target?.closest?.(".category-tab");if(!r||r===this._draggingTab)return;e.preventDefault();let o=Array.from(t.querySelectorAll(".category-tab")),s=o.indexOf(this._draggingTab),n=o.indexOf(r);s<0||n<0||s===n||(s<n?t.insertBefore(this._draggingTab,r.nextSibling):t.insertBefore(this._draggingTab,r))},!0),document.addEventListener("drop",e=>{let t=e.target?.closest?.(".category-tabs");!t||!this._draggingTab||this._originTabsEl&&t!==this._originTabsEl||e.preventDefault()},!0),document.addEventListener("dragend",e=>{let t=e.target?.closest?.(".category-drag-handle");if(!t)return;let r=t.closest(".category-tabs");if(!r||!this._draggingTab){this._draggingTab&&this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null;return}let o=Tr(r);Lr(o),xr(o),this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null},!0))}};i.categoryTabReorder=xt;v(()=>{xt.attach()});var $e="rss_subscriptions",x=null,te=null,Re=!1,he=!1,j=new Map,$=new Set,Bt=!1,Ae="",Te="",Pr=80,ge=0,pe=0,je=!1,M=[],Ge=0,me=0,ee=44,kt=10,K=0,Rt=0,Pt=new Map;function Ot(e){return new Promise(t=>window.setTimeout(t,Math.max(0,e||0)))}function Or(e){try{if(window.CSS&&typeof window.CSS.escape=="function")return window.CSS.escape(String(e||""))}catch{}return String(e||"").replace(/"/g,'\\"')}function Mr(e){let t=Array.isArray(e)?e:[];for(let r of t){let o=String(r||"").trim();if(!o)continue;let s=`rss-${o}`,n=`.platform-card[data-platform="${Or(s)}"]`,a=document.querySelector(n);if(!a)continue;let l=a.querySelectorAll(".news-item");if(l&&l.length>0)return!0}return!1}function Mt(e,t){let r=Array.isArray(e)?e:[];for(let o of r){let s=String(o||"").trim();s&&(t?$.add(s):$.delete(s))}}function He(){return document.getElementById("rssSubscriptionModal")}function ze(){return document.getElementById("rssSourcePickerModal")}function Fr(){try{return document.querySelector("#rssSubscriptionModal .settings-btn-primary")}catch{return null}}function Br(){try{return document.querySelector('#rssSubscriptionModal button[onclick="previewRssSubscription()"]')}catch{return null}}function Le(e){let r=(Array.isArray(e)?e:[]).filter(o=>o&&typeof o=="object").map(o=>({source_id:String(o.source_id||o.rss_source_id||"").trim(),url:String(o.url||"").trim(),feed_title:String(o.feed_title||"").trim(),column:String(o.column||"RSS").trim()||"RSS"})).filter(o=>!!o.source_id||!!o.url).sort((o,s)=>(o.source_id||"").localeCompare(s.source_id||""));return JSON.stringify(r)}function Dt(e,t){let r=Array.isArray(e)?e:[],o=Array.isArray(t)?t:[],s=new Set(r.map(a=>String(a?.source_id||a?.rss_source_id||"").trim()).filter(Boolean)),n=[];for(let a of o){let l=String(a?.source_id||a?.rss_source_id||"").trim();l&&(s.has(l)||n.push(l))}return n}function Ft(e,t){if(e)try{t?e.removeAttribute("disabled"):e.setAttribute("disabled","true")}catch{}}function X(){let e=Br(),t=Fr(),r=$t();if(Ft(e,!!r),r){let u=j.get(String(r||"").trim());u&&u.ok===!0&&Number(u.entries_count||0)===0&&k("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"})}let o=Array.isArray(te)?te:[],s=P.getSubscriptions(),n=Le(o)!==Le(s),l=Dt(o,s).every(u=>{let f=j.get(u);return!!f&&f.ok===!0&&Number(f.entries_count||0)>0});if(Ft(t,n&&l),!n){r&&(()=>{let u=j.get(String(r||"").trim());return u&&u.ok===!0&&Number(u.entries_count||0)===0})()||k("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"});return}if(!l){r&&(()=>{let u=j.get(String(r||"").trim());return u&&u.ok===!0&&Number(u.entries_count||0)===0})()||k("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"});return}k("",{variant:"info"})}async function Dr(e){let t=xe();t&&(t.innerHTML='<div style="color:#6b7280;">\u9884\u89C8\u4E2D...</div>');let r=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(e)}`),o=await r.json();if(!r.ok)throw new Error(o?.detail||"Preview failed");let s=o?.data||{},n=s?.feed?.title||"",a=Array.isArray(s?.entries)?s.entries:[],l=a.length,d=a.slice(0,5).map(u=>{let f=S(u?.title||""),c=S(u?.link||"");return c?`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><a href="${c}" target="_blank" rel="noopener noreferrer">${f||c}</a></div>`:`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${f}</div>`}).join("");if(!Re&&n&&(oe("rssFeedTitle",n),he=!0),j.set(String(e||"").trim(),{ok:!0,entries_count:l,ts:Date.now()}),l>0)try{let f=(x?String(x.url||"").trim():"")||String(o?.final_url||o?.url||"").trim(),c=re("rssColumn")||"RSS",m=re("rssFeedTitle")||String(x?.name||x?.host||"").trim(),g=P.getSubscriptions(),p=g.findIndex(w=>w.source_id&&w.source_id===String(e||"").trim()),h={source_id:String(e||"").trim(),url:f,feed_title:m,column:c,platform_id:""};p>=0?g[p]=h:g.unshift(h),P.setSubscriptions(g),U()}catch{}else k("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"});X(),t&&(t.innerHTML=`
            <div style="display:flex;flex-direction:column;gap:6px;">
                <div style="font-weight:800;">${S(n||"Feed")}</div>
                <div style="font-size:0.78rem;color:#6b7280;">\u6761\u76EE\u6570\uFF1A${a.length}</div>
                <div style="display:flex;flex-direction:column;gap:4px;">${d}</div>
            </div>`)}function qr(){return document.getElementById("rssSubscriptionList")}function xe(){return document.getElementById("rssSubscriptionPreview")}function Ir(){return document.getElementById("rssSubscriptionSaveStatus")}function k(e,t={}){let r=Ir();if(!r)return;let o=String(t.variant||"").toLowerCase(),s=o==="error"?"#dc2626":o==="success"?"#16a34a":"#6b7280";r.style.color=s,r.textContent=e==null?"":String(e)}function qt(){return document.getElementById("rssSelectedSourceId")}function Nr(){return document.getElementById("rssSelectedSourceLabel")}function $r(){return document.getElementById("rssRequestSection")}function jr(){return document.getElementById("rssSourceCategoryList")}function It(){return document.getElementById("rssSourceSearchInput")}function Nt(){return document.getElementById("rssSourceResults")}function Gr(){return document.getElementById("rssSourcePickerStatus")}function re(e){let t=document.getElementById(e);return t&&typeof t.value=="string"?t.value.trim():""}function oe(e,t){let r=document.getElementById(e);r&&(r.value=t==null?"":String(t))}function $t(){let e=qt();return e&&typeof e.value=="string"?e.value.trim():""}function Hr(e){x=e&&typeof e=="object"?e:null;let t=qt(),r=Nr(),o=x?String(x.id||"").trim():"",s=x?String(x.name||x.host||o):"",n=x?String(x.url||"").trim():"";t&&(t.value=o),r&&(r.textContent=o?`${s}${n?` (${n})`:""}`:"\u672A\u9009\u62E9"),o&&!Re&&(!re("rssFeedTitle")||he)&&(oe("rssFeedTitle",s),he=!0),o&&jt(o),X()}function jt(e){let t=String(e||"").trim();if(!t)return;let r=Date.now(),o=15e3,s=Pt.get(t)||0;r-s<o||(Pt.set(t,r),K&&(window.clearTimeout(K),K=0),K=window.setTimeout(async()=>{K=0;let n=Date.now()-(Rt||0);if(n<400){K=window.setTimeout(()=>{K=0,jt(t)},400-n);return}Rt=Date.now();try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:[t],priority:"high"})})}catch{}},300))}function ke(e){let t=Gr();t&&(t.textContent=e==null?"":String(e))}async function Gt(){let e=await fetch("/api/rss-source-categories"),t=await e.json();if(!e.ok)throw new Error(t?.detail||"Failed to load categories");let r=Array.isArray(t?.categories)?t.categories:[],o=jr();if(!o)return r;let s=r.map(n=>{let a=String(n?.id||""),l=String(n?.name||a||""),d=Number(n?.count||0),u=a===Ae;return`
          <button type="button" class="platform-select-action-btn" data-cat="${S(a)}" style="justify-content:flex-start;${u?"background:#111827;color:#fff;border-color:#111827;":""}">
            ${S(l)} <span style="opacity:0.7;">(${d})</span>
          </button>`}).join("");return o.innerHTML=s,o.querySelectorAll("button[data-cat]").forEach(n=>{n.addEventListener("click",()=>{Ae=String(n.getAttribute("data-cat")||""),Gt().catch(()=>{}),Ve({reset:!0})})}),r}async function Ht(e={}){let t=e.reset===!0;if(!je){je=!0;try{t&&(M=[],ge=0,pe=0),ke("\u52A0\u8F7D\u4E2D...");let r=new URLSearchParams;Te&&r.set("q",Te),Ae&&r.set("category",Ae),r.set("limit",String(Pr)),r.set("offset",String(ge));let o=await fetch(`/api/rss-sources/search?${r.toString()}`),s=await o.json();if(!o.ok)throw new Error(s?.detail||"Search failed");let n=Array.isArray(s?.sources)?s.sources:[];pe=Number(s?.total||0),t?M=n:M=M.concat(n),ge=Number(s?.next_offset??ge+n.length)||ge+n.length,zt();let l=M.length<pe;ke(`\u5DF2\u52A0\u8F7D ${M.length}/${pe}${l?"\uFF08\u7EE7\u7EED\u6EDA\u52A8\u52A0\u8F7D\uFF09":""}`)}finally{je=!1}}}function zt(){Ge||(Ge=window.requestAnimationFrame(()=>{Ge=0,zr()}))}function zr(){let e=Nt();if(!e)return;let t=e.scrollTop||0,r=e.clientHeight||360,o=M.length,s=o*ee,n=Math.max(0,Math.floor(t/ee)-kt),a=Math.min(o,Math.ceil((t+r)/ee)+kt),l=e.querySelector(":scope > .rss-src-inner");l||(e.innerHTML='<div class="rss-src-inner" style="position:relative;width:100%;"></div>',l=e.querySelector(":scope > .rss-src-inner")),l.style.height=`${s}px`;let d=[];for(let f=n;f<a;f++){let c=M[f]||{},m=String(c.id||"").trim(),g=String(c.name||c.host||m),p=String(c.url||"");d.push(`<div class="rss-source-item" data-source-id="${S(m)}" style="position:absolute;left:0;right:0;top:${f*ee}px;height:${ee}px;padding:8px 10px;border-bottom:1px solid #f3f4f6;cursor:pointer;display:flex;align-items:center;gap:8px;">
              <div style="min-width:0;flex:1;">
                <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${S(g)}</div>
                <div style="font-size:0.78rem;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${S(p)}</div>
              </div>
            </div>`)}l.innerHTML=d.join(""),l.querySelectorAll(".rss-source-item[data-source-id]").forEach(f=>{f.addEventListener("click",()=>{let c=String(f.getAttribute("data-source-id")||"").trim(),m=M.find(g=>g&&String(g.id||"").trim()===c)||null;Hr(m),We()})}),t+r>=s-ee*6&&M.length<pe&&Ht({reset:!1}).catch(f=>{ke(f?.message||String(f))})}function Ve(e={}){let t=e.reset!==!1;Ht({reset:t}).catch(r=>{ke(r?.message||String(r))})}function Vr(){let e=ze();if(!e)return;Bt=!0,e.classList.add("show");let t=It();t&&(t.value=Te,t.focus()),Gt().catch(()=>{}),Ve({reset:!0})}function We(){let e=ze();e&&(Bt=!1,e.classList.remove("show"))}function U(){let e=qr();if(!e)return;let t=P.getSubscriptions();if(!t.length){e.innerHTML='<div style="color:#6b7280;font-size:0.85rem;">\u6682\u65E0\u8BA2\u9605</div>';return}let r=t.map((o,s)=>{let n=String(o?.source_id||o?.rss_source_id||"").trim(),a=S(o.url||""),l=S(o.feed_title||""),d=S(o.column||"RSS"),u=l?`${l}`:a,f=n&&$.has(n);return`
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb;">
                <div style="min-width:0;flex:1;">
                    <div style="display:flex;gap:8px;align-items:baseline;">
                        <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                            <span style="font-weight:700;font-size:0.9rem;color:#111827;">${u}</span>
                            ${f?'<span style="margin-left:8px;font-weight:400;font-size:0.75rem;color:#9ca3af;">\u540C\u6B65\u4E2D...</span>':""}
                            <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> \u2014 </span>
                            <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${a}</span>
                        </div>
                        <div style="flex:0 0 auto;font-size:0.72rem;color:#6b7280;white-space:nowrap;">\u680F\u76EE\uFF1A${d}</div>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex:0 0 auto;">
                    <button type="button" class="platform-select-action-btn" onclick="removeRssSubscription(${s})">\u5220\u9664</button>
                </div>
            </div>`}).join("");e.innerHTML=r,X()}var P={getSubscriptionsRaw(){let e=y.get($e,[]);return Array.isArray(e)?e:[]},setSubscriptionsRaw(e){if(!Array.isArray(e)){y.set($e,[]);return}y.set($e,e)},getSubscriptions(){return this.getSubscriptionsRaw().filter(t=>t&&typeof t=="object").map(t=>({source_id:String(t.source_id||t.rss_source_id||"").trim(),url:String(t.url||"").trim(),feed_title:String(t.feed_title||"").trim(),column:String(t.column||"RSS").trim()||"RSS",platform_id:String(t.platform_id||"").trim()})).filter(t=>!!t.source_id||!!t.url)},setSubscriptions(e){this.setSubscriptionsRaw(e)},open(){let e=He();if(!e)return;try{te=this.getSubscriptions()}catch{te=null}oe("rssFeedTitle",""),he=!1,Re=!1,j.clear(),$.clear(),U();let t=xe();t&&(t.innerHTML=""),k(""),e.classList.add("show"),X()},close(){let e=He();e&&e.classList.remove("show")},async previewCurrent(){let e=$t();if(!e){alert("\u8BF7\u9009\u62E9 RSS \u6E90");return}try{await Dr(e)}catch(t){j.set(String(e||"").trim(),{ok:!1,entries_count:0,ts:Date.now(),error:String(t?.message||t)}),X();let r=xe();r&&(r.innerHTML=`<div style="color:#dc2626;">${S(t?.message||String(t))}</div>`)}},removeAt(e){let t=this.getSubscriptions();if(!(e<0||e>=t.length)){try{let r=String(t[e]?.source_id||t[e]?.rss_source_id||"").trim();r&&$.delete(r)}catch{}t.splice(e,1),this.setSubscriptions(t),U()}},async saveAndRefresh(){try{let e=Array.isArray(te)?te:[],t=this.getSubscriptions(),r=Le(e)!==Le(t),s=Dt(e,t).every(c=>{let m=j.get(c);return!!m&&m.ok===!0&&Number(m.entries_count||0)>0});if(!r){k("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"}),X();return}if(!s){k("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"}),X();return}let n=new Set(e.map(c=>String(c?.source_id||c?.rss_source_id||"").trim()).filter(Boolean)),a=t.map(c=>String(c?.source_id||c?.rss_source_id||"").trim()).filter(c=>!!c&&!n.has(c));if(a.length>0&&(Mt(a,!0),U()),a.length>0)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:a,priority:"high"})})}catch{}k("\u6B63\u5728\u4ECE\u6E90\u83B7\u53D6\u6700\u65B0\u5185\u5BB9...",{variant:"info"});try{let c=document.querySelector("#rssSubscriptionModal .settings-btn-primary");c&&c.setAttribute("disabled","true")}catch{}let l=Date.now(),d=5e3,u=[0,300,700,1500,2500],f=!1;for(let c of u){let m=Date.now()-l,g=d-m;if(g<=0)break;if(c>0&&await Ot(Math.min(c,g)),await i.data.refreshViewerData({preserveScroll:!0}),a.length>0){let p=[];for(let h of a)$.has(h)&&Mr([h])&&$.delete(h),$.has(h)&&p.push(h);if(p.length===0){f=!0,U();break}U()}if(a.length===0){f=!0;break}}f?k("\u5DF2\u83B7\u53D6\u5230\u5185\u5BB9\uFF0C\u5373\u5C06\u8FD4\u56DE\u2026",{variant:"success"}):(a.length>0&&(Mt(a,!1),U()),k("\u5DF2\u8BA2\u9605\uFF0C\u5185\u5BB9\u7A0D\u540E\u66F4\u65B0",{variant:"info"}));try{let c=document.querySelector("#rssSubscriptionModal .settings-btn-primary");c&&c.removeAttribute("disabled")}catch{}await Ot(f?200:800),this.close()}catch(e){console.error("rss refresh error:",e);try{k(String(e?.message||e),{variant:"error"})}catch{}try{let t=document.querySelector("#rssSubscriptionModal .settings-btn-primary");t&&t.removeAttribute("disabled")}catch{}}}};async function Wr(){let e=re("rssRequestUrl"),t=re("rssRequestTitle"),r=re("rssRequestNote");if(!e){alert("\u8BF7\u8F93\u5165 URL");return}if(!t){alert("\u8BF7\u8F93\u5165 \u6807\u9898");return}if(!r){alert("\u8BF7\u8F93\u5165 \u5907\u6CE8");return}let o=xe();o&&(o.innerHTML='<div style="color:#6b7280;">\u63D0\u4EA4\u7533\u8BF7\u4E2D...</div>');try{let s=await fetch("/api/rss-source-requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,title:t,note:r})}),n=await s.json();if(!s.ok)throw new Error(n?.detail||"Submit failed");o&&(o.innerHTML=`<div style="color:#16a34a;">\u5DF2\u63D0\u4EA4\u7533\u8BF7\uFF0C\u72B6\u6001\uFF1A${S(n?.status||"pending")}</div>`),oe("rssRequestUrl",""),oe("rssRequestTitle",""),oe("rssRequestNote","")}catch(s){o&&(o.innerHTML=`<div style="color:#dc2626;">${S(s?.message||String(s))}</div>`)}}function Kr(){let e=$r();if(!e)return;let t=e.style.display!=="none";e.style.display=t?"none":"block"}window.openRssSubscriptionModal=()=>{try{let e=document.getElementById("rssSubscriptionNewBadge");e&&(e.style.display="none",localStorage.setItem("rss_subscription_badge_dismissed","true"))}catch{}P.open()};window.closeRssSubscriptionModal=()=>P.close();window.previewRssSubscription=()=>P.previewCurrent();window.saveRssSubscriptions=()=>P.saveAndRefresh();window.removeRssSubscription=e=>P.removeAt(parseInt(e,10));window.submitRssSourceRequest=()=>Wr();window.toggleRssRequestSection=()=>Kr();window.openRssSourcePicker=()=>Vr();window.closeRssSourcePicker=()=>We();i.subscription=P;v(function(){let e=He();if(!e)return;let t=document.getElementById("rssFeedTitle");t&&t.addEventListener("input",()=>{Re=String(t.value||"").trim()!=="",he=!1}),e.addEventListener("keydown",n=>{n.key==="Escape"&&P.close()});let r=ze();r&&r.addEventListener("keydown",n=>{n.key==="Escape"&&We()});let o=Nt();o&&o.addEventListener("scroll",()=>{zt()});let s=It();s&&s.addEventListener("input",()=>{Te=String(s.value||"").trim(),me&&(window.clearTimeout(me),me=0),me=window.setTimeout(()=>{me=0,Ve({reset:!0})},250)})});function se(e){let t=e;return t?t.nodeType===3?t.parentElement||null:t:null}function Vt(e){if(!e)return!1;let t=e.scrollWidth||0,r=e.clientWidth||0;return t>r+1}function Wt(e){return se(e)?.closest?.(".platform-card")?.closest?.(".platform-grid")||null}function Ke(e){let t=se(e);return!t?.closest||t.closest(".platform-drag-handle")?!1:!!t.closest(".platform-header")||!!t.closest(".platform-name")}v(()=>{let t=null,r=!1,o=null,s=0,n=0,a=!1,l=0,d=()=>{t=null,r=!1,o=null,s=0,n=0,a=!1;try{document.body.classList.remove("tr-platform-title-dragging")}catch{}},u=(c,m)=>{if(!Ke(c)||document.querySelector(".platform-card.dragging"))return!1;let g=Wt(c);if(!g||!Vt(g))return!1;o=g,s=m,n=g.scrollLeft||0,a=!1;try{document.body.classList.add("tr-platform-title-dragging")}catch{}return!0};document.addEventListener("pointerdown",c=>{if(c.button!==0)return;let m=se(c.target);u(m,c.clientX)&&(t=c.pointerId)},{passive:!0}),document.addEventListener("mousedown",c=>{if(c.button!==0||t!==null)return;let m=se(c.target);u(m,c.clientX)&&(r=!0)},{passive:!0}),document.addEventListener("pointermove",c=>{if(t===null||c.pointerId!==t||!o)return;if(document.querySelector(".platform-card.dragging")){d();return}let m=c.clientX-s;if(!a&&Math.abs(m)<6)return;a=!0;try{c.preventDefault()}catch{}let g=Math.max(0,(o.scrollWidth||0)-(o.clientWidth||0)),p=Math.max(0,Math.min(g,n-m));o.scrollLeft=p},{passive:!1}),document.addEventListener("mousemove",c=>{if(!r||!o)return;if(document.querySelector(".platform-card.dragging")){d();return}let m=c.clientX-s;if(!a&&Math.abs(m)<6)return;a=!0;try{c.preventDefault()}catch{}let g=Math.max(0,(o.scrollWidth||0)-(o.clientWidth||0)),p=Math.max(0,Math.min(g,n-m));o.scrollLeft=p},{passive:!1});let f=()=>{t!==null&&(a&&(l=Date.now()+600),d())};document.addEventListener("pointerup",f,{passive:!0}),document.addEventListener("pointercancel",f,{passive:!0}),document.addEventListener("mouseup",()=>{r&&(a&&(l=Date.now()+600),d())},{passive:!0}),document.addEventListener("click",c=>{if(Date.now()>l)return;let g=se(c.target);if(Ke(g)){try{c.preventDefault()}catch{}try{c.stopPropagation()}catch{}try{c.stopImmediatePropagation()}catch{}}},!0),document.addEventListener("wheel",c=>{let m=typeof document.elementFromPoint=="function"?document.elementFromPoint(c.clientX,c.clientY):null,g=se(m||c.target);if(!c.shiftKey||!Ke(g)||document.querySelector(".platform-card.dragging"))return;let p=Wt(g);if(!p||!Vt(p))return;let h=typeof c.deltaX=="number"&&c.deltaX!==0?c.deltaX:c.deltaY;if(!h)return;try{c.preventDefault()}catch{}let w=Math.max(0,(p.scrollWidth||0)-(p.clientWidth||0)),_=Math.max(0,Math.min(w,(p.scrollLeft||0)+h));p.scrollLeft=_},{passive:!1})});v(function(){if(localStorage.getItem("category_settings_badge_dismissed")==="true"){let r=document.getElementById("categorySettingsNewBadge");r&&(r.style.display="none")}if(localStorage.getItem("rss_subscription_badge_dismissed")==="true"){let r=document.getElementById("rssSubscriptionNewBadge");r&&(r.style.display="none")}let e=i.settings.getCategoryConfig();e&&(e.customCategories&&e.customCategories.length>0||e.hiddenDefaultCategories&&e.hiddenDefaultCategories.length>0||e.categoryOrder&&e.categoryOrder.length>0||e.platformOrder&&typeof e.platformOrder=="object"&&Object.keys(e.platformOrder).length>0)?i.data.refreshViewerData({preserveScroll:!1}):document.body.classList.add("categories-ready")});})();
