## 1. Safety Rails (Preflight)
- [ ] 1.1 增加“服务器架构预检”步骤：在执行任何可能影响线上服务的操作前，先获取 server 的 `arch/os`（例如 `uname -m` 或 `docker info`）。
- [ ] 1.2 增加“本地镜像架构预检”步骤：确认将要部署的镜像是目标 server 可运行的架构（例如 `docker image inspect`）。
- [ ] 1.3 增加“网络可用性预检”步骤：如果 server 无法访问 Docker Hub，则必须切换到离线部署（docker save/load）或直接中止；中止时不得影响现有服务。

## 2. Safety Rails (Execution)
- [ ] 2.1 禁止直接拼接复杂 SSH 命令执行破坏性操作（包含复杂引号、多层 heredoc、动态变量拼接）。
- [ ] 2.2 将远程动作拆分为“只读预检”和“可回滚执行”两阶段；执行阶段必须在预检通过后才运行。
- [ ] 2.3 执行阶段采用更安全的方式：使用 `ssh ... bash -s` 运行严格 heredoc（或先上传脚本到服务器再执行），避免本地 shell 重新解释。

## 3. Minimal Downtime
- [ ] 3.1 在确认新版本镜像可用（已 load/pull）并能健康启动前，不得停止/删除线上旧容器。
- [ ] 3.2 增加失败回滚步骤：失败时恢复 `.env.prev` 并启动旧版本；并输出明确的恢复指令。

## 4. Verification
- [ ] 4.1 验证：故意构建 arm64 镜像并尝试部署到 amd64 server，预检应阻止部署且不影响线上服务。
- [ ] 4.2 验证：故意制造 Docker Hub 不可达，预检应提示使用 `--offline` 或中止且不影响线上服务。
- [ ] 4.3 验证：执行阶段失败（脚本退出非 0）时，不会把线上服务“停在半路”，且能通过回滚恢复。
